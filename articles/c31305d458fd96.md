---
title: "RSAå…¬é–‹éµã¨Rubyã§æš—å·åŒ–ã—ç§˜å¯†éµã¨Elixirã§å¾©å·åŒ–ã™ã‚‹"
emoji: "ğŸ”"
type: "tech"
topics:
  - "elixir"
  - "ruby"
  - "erlang"
published: true
published_at: "2021-07-20 20:02"
---

RSA ç§˜å¯†éµã€å…¬é–‹éµã®ãƒšã‚¢ã‚’ç”¨ã„ãŸæš—å·åŒ–ã¨å¾©å·åŒ–ã«ã¤ã„ã¦èª¿ã¹ãŸã€‚ç‰¹ã« Ruby ã§æš—å·åŒ–ã— Elixir ã§å¾©å·åŒ–ã™ã‚‹ã‚ˆã†ãªã€è¨€èªã‚’è·¨ã„ã å‡¦ç†ã§ã‚‚å•é¡Œãªãè¡Œãˆã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã€‚

# æ‰‹é †

## RSA ç§˜å¯†éµã€å…¬é–‹éµ

### RSA ç§˜å¯†éµã®ç”Ÿæˆ

`openssl` ã®ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ `genrsa` ã‚’ä½¿ã†ã¨ RSA éµãŒä½œã‚Œã‚‹ã€‚å¼•æ•°ã«ã‚ˆã£ã¦ãƒ“ãƒƒãƒˆæ•°ãªã©ã‚‚å¤‰ãˆã‚‰ã‚Œã‚‹ãŒä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ç”Ÿæˆã—ã¦ã„ã‚‹ã€‚

```sh
$ openssl genrsa > private.pem
Generating RSA private key, 2048 bit long modulus
.............................................................................................................................................................................................................................................+++
...............+++
e is 65537 (0x10001)
$ ls
private.pem
```

### RSA å…¬é–‹éµã®ç”Ÿæˆ

RSA ç§˜å¯†éµãŒã‚ã‚Œã°ã€å¯¾ã«ãªã‚‹å…¬é–‹éµã‚’ç”Ÿæˆã§ãã‚‹ã€‚`openssl` ã®ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ `rsa` ã‚’ä½¿ã†ã€‚

```sh
$ openssl rsa -in private.pem -pubout -out public.pem
writing RSA key
$ ls
private.pem public.pem
```

## Ruby

```sh
$ ruby --version
ruby 2.7.0dev (2019-06-04 trunk 14b5ccf91b) [x86_64-darwin18]
```

### RSA å…¬é–‹éµã‚’ä½¿ã£ã¦ Ruby ã§æš—å·åŒ–

[`OpenSSL::PKey::RSA.new`](https://docs.ruby-lang.org/ja/2.6.0/method/OpenSSL=3a=3aPKey=3a=3aRSA/s/new.html) ã¨ [`public_encrypt`](https://docs.ruby-lang.org/ja/2.6.0/method/OpenSSL=3a=3aPKey=3a=3aRSA/i/public_encrypt.html) ã‚’åˆ©ç”¨ã—ã¦ã€RSA å…¬é–‹éµã‚’ä½¿ã£ãŸæš—å·åŒ–ãŒè¡Œãˆã‚‹ã€‚

`public_encrypt` ã®ç¬¬äºŒå¼•æ•°ã«ã‚ãŸã‚‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯äº’æ›æ€§ã®ãŸã‚ã«ã‚»ã‚­ãƒ¥ã‚¢ã§ãªã„ã‚‚ã®ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚
è‰¯ãã‚ã‹ã‚‰ãªã„(=ç‰¹ã«åˆ¶ç´„ãŒãªã„)å ´åˆã¯ [`OpenSSL::PKey::RSA::PKCS1_OAEP_PADDING`](https://docs.ruby-lang.org/ja/2.6.0/method/OpenSSL=3a=3aPKey=3a=3aRSA/c/PKCS1_OAEP_PADDING.html) ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã‚ã£ãŸã®ã§å¾“ã†ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ encrypt.rb ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã€‚æ¨™æº–å…¥åŠ›ã‹ã‚‰æ–‡å­—ã‚’å—ã‘ã¨ã£ã¦æš—å·åŒ–ã€Base64 åŒ–ã€çµæœã‚’æ¨™æº–å‡ºåŠ›ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã ã€‚

```ruby
#!/usr/bin/env ruby

require "openssl"
require "base64"

string = ARGF.read
public_key_file = "public.pem"


public_key = OpenSSL::PKey::RSA.new(File.read(public_key_file))
puts Base64.encode64(public_key.public_encrypt(string, OpenSSL::PKey::RSA::PKCS1_OAEP_PADDING))
```

ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ©ç”¨ã™ã‚‹ã€‚

```sh
$ echo "hellllllllllllllloooooooooooooo" | ruby encrypt.rb > encrypted.txt

$ cat encrypted.txt
xhxN+YQslh6hA53VoWWtcI73W7+I8pgty6NeM/2Sa+o9/AaQk/pQdnFkt39l
9twKi5BRIVWrzkul5Yb1XcGWpxNQ5/lNNPcdD161f/39ETpJOcc8WHYofZAD
YsxxxlW0bemJBqxRF7QB/fQoe8BhFF5lIlNsQOya7sqWfB8dHtBETgSeKMmd
FtSEkdVznkynhJJ3CKQeSfy08ALcOhVBTcpWJ237e3Ihdnv2hb22wxaPvK2X
UEC5yrh1NHnPsxZ+nu4lhILfOV/3HTUt3aheeJ4Tmb4iZzr6847ENTpf1dPY
Z5p8TT8GyVV1fMqRGqYA3DkhSWtFUfYrS4AD2fDHaQ==
```

### RSA ç§˜å¯†éµã‚’ä½¿ã£ã¦ Ruby ã§å¾©å·åŒ–

[`OpenSSL::PKey::RSA.new`](https://docs.ruby-lang.org/ja/2.6.0/method/OpenSSL=3a=3aPKey=3a=3aRSA/s/new.html) ã¨ [`private_decrypt`](https://docs.ruby-lang.org/ja/2.6.0/method/OpenSSL=3a=3aPKey=3a=3aRSA/i/private_decrypt.html) ã‚’åˆ©ç”¨ã—ã¦ã€RSA æš—å·éµã‚’ä½¿ã£ãŸå¾©å·åŒ–ãŒè¡Œãˆã‚‹ã€‚

`private_decrypt` ã®ç¬¬äºŒå¼•æ•°ã¯ `public_decrypt` ã§è¨­å®šã—ãŸã‚‚ã®ã¨åŒã˜ã«ã—ãªã‘ã‚Œã°å¾©å·åŒ–ã§ããªã„ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ decrypt.rb ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã€‚æ¨™æº–å…¥åŠ›ã‹ã‚‰ Base64 åŒ–ã—ãŸæš—å·æ–‡å­—ã‚’å—ã‘ã¨ã£ã¦ã€Base64 åŒ–ã‚’è§£ãã€å¾©å·åŒ–ã—ã€çµæœã‚’æ¨™æº–å‡ºåŠ›ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã ã€‚

```ruby
#!/usr/bin/env ruby

require "openssl"
require "base64"

encrypted_string = ARGF.read
private_key_file = "private.pem"

private_key = OpenSSL::PKey::RSA.new(File.read(private_key_file))
puts private_key.private_decrypt(Base64.decode64(encrypted_string), OpenSSL::PKey::RSA::PKCS1_OAEP_PADDING)
```

ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ©ç”¨ã™ã‚‹ã€‚å¾©å·ã‚‚ã†ã¾ãæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‚ˆã†ã ã€‚

```sh
$ cat encrypted.txt | ruby decrypt.rb
hellllllllllllllloooooooooooooo
```

## Elixir

```sh
$ elixir --version
Erlang/OTP 22 [erts-10.4] [source] [64-bit] [smp:8:8] [ds:8:8:10] [async-threads:1] [hipe]

Elixir 1.9.0-rc.0 (aad7aa4) (compiled with Erlang/OTP 20)
```

### RSA ç§˜å¯†éµã‚’ä½¿ã£ã¦ Elixir ã§å¾©å·åŒ–

æš—å·åŒ–ã—ãŸã‚‚ã®ã¯å½“ç„¶åˆ¥ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚’ä½¿ã£ã¦ã‚‚å¾©å·åŒ–å¯èƒ½ã ã€‚Elixir ã§å¾©å·åŒ–ã—ã¦ã¿ã‚‹ã€‚
éµã‚’æ‰±ã†å ´åˆã¯ Erlang ã® [`public_key`](http://erlang.org/doc/man/public_key.html) ã¨ã„ã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã†ã¨ã‚ˆã„ã€‚

Ruby ã®å ´åˆã¨ç•°ãªã‚Š `pem` ã‚’ `decode` ã—ã¦ `pem_entry` ã‚’å–ã‚Šå‡ºã—ã€æ¬¡ã« `pem_entry` ã‚’ `decode` ã—ã¦ `key` ã‚’å–ã‚Šå‡ºã™ã¨ã„ã† 2 æ‰‹é–“å¿…è¦ã§ã‚ã‚‹ã“ã¨ã«æ°—ã‚’ã¤ã‘ã‚Œã°ã€ä»–ã¯ãã‚Œã»ã©å·®ç•°ã¯ãªã„ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ decrypt.exs ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã€‚æ¨™æº–å…¥åŠ›ã‹ã‚‰ Base64 åŒ–ã—ãŸæš—å·æ–‡å­—ã‚’å—ã‘ã¨ã£ã¦ã€Base64 åŒ–ã‚’è§£ãã€å¾©å·åŒ–ã—ã€çµæœã‚’æ¨™æº–å‡ºåŠ›ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã ã€‚

```elixir
#!/usr/bin/env elixir

encrypted_string = IO.read(:stdio, :all)
private_key_file = "private.pem"

[rsa_entry] = :public_key.pem_decode(File.read!(private_key_file))
private_key = :public_key.pem_entry_decode(rsa_entry)
IO.puts :public_key.decrypt_private(Base.decode64!(encrypted_string, ignore: :whitespace), private_key, rsa_pad: :rsa_pkcs1_oaep_padding)
```

ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ©ç”¨ã™ã‚‹ã€‚Elixir ã«ã‚ˆã‚‹å¾©å·ã‚‚ã†ã¾ãæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‚ˆã†ã ã€‚

```sh
$ cat encrypted.txt | elixir decrypt.exs
hellllllllllllllloooooooooooooo
```

### RSA å…¬é–‹éµã‚’ä½¿ã£ã¦ Elixir ã§æš—å·åŒ–

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ encrypt.exs ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã€‚æ¨™æº–å…¥åŠ›ã‹ã‚‰æ–‡å­—ã‚’å—ã‘ã¨ã£ã¦æš—å·åŒ–ã€Base64 åŒ–ã€çµæœã‚’æ¨™æº–å‡ºåŠ›ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã ã€‚

```elixir
#!/usr/bin/env elixir

string = IO.read(:stdio, :all)
public_key_file = "public.pem"

[rsa_entry] = :public_key.pem_decode(File.read!(public_key_file))
public_key = :public_key.pem_entry_decode(rsa_entry)
IO.puts Base.encode64!(:public_key.encrypt_public(string, public_key, rsa_pad: :rsa_pkcs1_oaep_padding))
```

ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ©ç”¨ã™ã‚‹ã€‚Elixir ã® Base64 åŒ–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æ”¹è¡Œã‚’ä»˜ä¸ã—ãªã„æ¨¡æ§˜ã ã€‚ã—ã‹ã—å•é¡Œãªãå¾©å·ã§ããŸã€‚

```sh
$ echo "hellllllllllllllloooooooooooooo" | elixir encrypt.exs > encrypted2.txt

$ cat encrypted2.txt
FCf12BTnonV5R8haK08E5zTd1ypsLkKdetjNtpw5xBJ7Jb1F3hJo1TWTKkiOHTZXKCx+LMOjF0BjjvsiK2irpQv8fr68HwHuEklGCxFlM3YuaCUo2zzfZFCSubpTNggf5HHp2CJurlTa4j5BdLqJb2geg0qGCnVWhfxvNH8orbTlXTMPV8+JuvthhL36fTKwURp/F+UPmyOoipJAaCSMqkbLloGJ39wj0ENZjLNf2hDlF2gvnICApcLj3NsqxhfSw7ieN+DWzrxIiZ38w1M4+GK2YQgp+/Or0sbx7gIcb6vaF7EkRB6SxTMh88Bu6FH38Un+Vyu89Qv/8qUmIa/Mug==

$ cat encrypted2.txt | ruby decrypt.rb
hellllllllllllllloooooooooooooo
```

# ã¾ã¨ã‚

ã©ã®çµ„ã¿åˆã‚ã›ã§ã‚‚ RSA ç§˜å¯†éµã€å…¬é–‹éµã‚’ç”¨ã„ãŸæš—å·åŒ–å¾©å·åŒ–ãŒè¡Œãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

```sh
$ echo "1234567" | ruby encrypt.rb | ruby decrypt.rb
1234567
$ echo "1234567" | ruby encrypt.rb | elixir decrypt.exs
1234567
$ echo "1234567" | elixir encrypt.exs | ruby decrypt.rb
1234567
$ echo "1234567" | elixir encrypt.exs | elixir decrypt.exs
1234567
```
