---
title: "AWS CDKã‚’ä½¿ã£ã¦AWS Lambdaã¸é…å‚™ã—ãŸGoè¨€èªã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæ›¸ã‹ã‚ŒãŸContainerã®ç›£è¦–ã‚’NewRelicã§è¡Œã†"
emoji: "ğŸ‘»"
type: "tech"
topics:
  - "docker"
  - "go"
  - "lambda"
  - "cdk"
  - "newrelic"
published: true
published_at: "2022-02-23 21:53"
---

AWS CDK(ä»¥ä¸‹ CDK ã¨å‘¼ã¶) ã‚’ä½¿ã£ã¦ Container Image å½¢å¼(ä»¥ä¸‹ Container å½¢å¼ã¨å‘¼ã¶)ã§é…å¸ƒã—ãŸ Go è¨€èªã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ AWS Lambda(ä»¥ä¸‹ Lambda ã¨å‘¼ã¶) ã®ç›£è¦–ã‚’ New Relic ã§è¡Œã†ã«ã¯ã€[Monitoring AWS Lambda with Serverless monitoring](https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/monitoring-aws-lambda-serverless-monitoring) ã«æ›¸ã„ã¦ã‚ã‚‹ã“ã¨ã‚’ä¸Šã‹ã‚‰é †ç•ªã«èª­ã‚“ã§é€²ã‚ã‚‹ã¨ã‚ˆã„ã€‚ãŸã  New Relic ã®æ–‡ã¯æ±ç”¨çš„ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã‹ã€è©¦è¡ŒéŒ¯èª¤ã‚„åˆ¤æ–­ã‚’è¦ã™ã‚‹éƒ¨åˆ†ãŒæ®‹ã£ã¦ã„ã‚‹ã€‚ãã‚Œã‚‰ã«ã¤ã„ã¦æ›¸ãã€‚

New Relic ã§è¡Œã„ãŸã„ä»¥ä¸‹ã® 2 ã¤ã®æ©Ÿèƒ½ã¯ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®éƒ¨åˆ†ã¯é‡è¤‡ã—ã¦ã„ã‚‹ã‚‚ã®ã®åˆ¥ã€…ã«å‹•ä½œã™ã‚‹ãŸã‚ã€ãã‚Œãã‚Œã®ãƒˆãƒ”ãƒƒã‚¯ã«åˆ†ã‘ã¦ã¨ã‚Šã‚ã’ã‚‹ã€‚

- Lambda ã®å‡¦ç†ã‚’è¨ˆæ¸¬ï¼ˆå‡¦ç†å›æ•°ã€å‡¦ç†ã«ã‹ã‹ã£ãŸæ™‚é–“ã€ä¸¦è¡Œå‡¦ç†æ•°ã€ã‚¨ãƒ©ãƒ¼æ•°ãªã©ï¼‰ã—é›†è¨ˆã™ã‚‹
- Lambda ã®ãƒ­ã‚°ã‚’é›†è¨ˆã™ã‚‹

# Lambda ã®å‡¦ç†ã‚’è¨ˆæ¸¬ï¼ˆå‡¦ç†å›æ•°ã€å‡¦ç†ã«ã‹ã‹ã£ãŸæ™‚é–“ã€ä¸¦è¡Œå‡¦ç†æ•°ã€ã‚¨ãƒ©ãƒ¼æ•°ãªã©ï¼‰ã—é›†è¨ˆã™ã‚‹

## Lambda ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ã¯ `go1.x` ã§ã¯ãªã `provided.al2` ã‚’ä½¿ã†

[Recommended AWS Lambda language runtimes](https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/get-started/compatibility-requirements-aws-lambda-monitoring/#languages)

New Relic ã§ã¯ AWS ãŒ Go è¨€èªã®ãŸã‚ã«æä¾›ã—ã¦ã„ã‚‹ `go1.x` ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ã‚ãšã€AWS ãŒæ±ç”¨çš„ãªåˆ©ç”¨ã‚’æƒ³å®šã—ã¦æä¾›ã—ã¦ã„ã‚‹ `provided` ã‚„ `provided.al2` ã®åˆ©ç”¨ã‚’ãŠã™ã™ã‚ã—ã¦ã„ã‚‹ã€‚ç†ç”±ã¯

> We recommend building self-hosting Go lambda functions, because the latest AWS Lambda APIs are not supported in the AWS go1.x runtime.

ã¨ã€`go1.x` ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒæœ€æ–°ã® AWS Lambda API ã«å¯¾å¿œã—ã¦ã„ãªã„ãŸã‚ã ã€‚

`provided` ã¯ç„¡å°ã® Amazon Linuxã€`provided.al2` ã¯ Amazon Linux2 ã‚’ãƒ™ãƒ¼ã‚¹ã® OS ã¨ã—ãŸãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚ã‚‹ã€‚å¤ã„æ–¹ã® OS ã‚’ã‚ãˆã¦åˆ©ç”¨ã™ã‚‹ç†ç”±ãŒãªã‹ã£ãŸã®ã§ `provided.al2` ã‚’æ¡ç”¨ã—ãŸã€‚

## AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ New Relic ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ã«ã¯ `newrelic-lambda` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†

[Step 1: Link your AWS and New Relic accounts](https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/enable-lambda-monitoring/account-linking)

AWS ã®ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã¯ã€ã§ãã‚‹ã ã‘å°‘ãªã„ãƒ„ãƒ¼ãƒ«ã§å®Œçµã•ã›ã¦ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®è¦‹é€šã—ã‚’è‰¯ãã—ã¦ãŠããŸã„ã€‚ä»Šå›ã ã¨æ—¢ã« CDK ã‚’åˆ©ç”¨ã—ãŸãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã‚’è¡Œã£ã¦ã„ã‚‹ã®ã§ã€ã§ãã‚Œã°ãƒ„ãƒ¼ãƒ«ã‚’è¶³ã•ãšã«ã™ã¾ã›ãŸã„ã€‚ãã†ã„ã†æ€ã„ã‚’ã‚‚ã¡ãªãŒã‚‰ã‚‚ã€ ä»¥ä¸‹ã®ã‚ˆã†ãªç†ç”±ã‹ã‚‰ AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ New Relic ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ã«ã¯ `newrelic-lambda integrations install` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã“ã¨ã«æ±ºã‚ãŸã€‚

New Relic è‡ªèº«ãŒãŠã™ã™ã‚ã—ã¦ã„ã‚‹ã“ã¨ã€‚ã•ã‚‰ã« AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¯ã«ä¸€åº¦å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã‚ˆãã€AWS ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¤‰æ›´ã‚’åŠ ãˆãŸã¨ãã«éƒ½åº¦å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒãªã„ã“ã¨ã€‚ã•ã‚‰ã« CLI ã§ä½œã‚‰ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã¯ Cloud Formation ã®ã‚¹ã‚¿ãƒƒã‚¯ã§ç®¡ç†ã•ã‚Œã€ãã®åå‰ã¯ `NewRelicLogIngestion` ã‚„ `NewRelicLicenseKeySecret` ãªã© `NewRelic` ã‹ã‚‰å§‹ã¾ã‚Šã€è‡ªèº«ãŒä½œæˆã—ãŸã‚‚ã®ã¨è¦‹åˆ†ã‘ãŒå®¹æ˜“ã§ã€é¢å€’ãªçŠ¶æ…‹ã‚’å¼•ãèµ·ã™å¿ƒé…ãŒå°‘ãªã‹ã£ãŸãŸã‚ã ã€‚

AWS ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒ default ã§ãªãã€æŒ‡å®šã—ãŸã‚‚ã®ã‚’ä½¿ã£ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€[AWS regions and profiles](https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/enable-lambda-monitoring/account-linking#aws-env-variables)ã«ã‚ã‚‹ã¨ãŠã‚Šã€ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã™ã‚‹ã¨ã‚ˆã„ã€‚

`AWS_PROFILE=YOUR_AWS_PROFILE newrelic-lambda integrations install --nr-account-id YOUR_NR_ACCOUNT_ID --nr-api-key YOUR_NEW_RELIC_USER_KEY`

## New Relic ã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã¦ã„ã‚‹ Lambda Layer ç›¸å½“ã®æ©Ÿèƒ½ã‚’ Container Image ã‚’åˆ©ç”¨ã—ãŸ Lambda ã¸é©ç”¨ã™ã‚‹

[Step 4: Instrument your own Lambda functions](https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/enable-lambda-monitoring/instrument-your-own/)

New Relic ãŒ Lambda ã‚’è¨ˆæ¸¬ã™ã‚‹æ©Ÿèƒ½ã¯ [Lambda Layer](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ã‚’ç”¨ã„ã¦å®Ÿç¾ã•ã‚Œã¦ã„ã‚‹ã€‚Lambda Layer ã¯

> You can use layers only with Lambda functions deployed as a .zip file archive.

ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€Zip ã§é…å¸ƒã—ã¦ã„ã‚‹ Lambda ã§ã—ã‹ä½¿ãˆãªã„ã€‚ç§ãŒåˆ©ç”¨ã—ã¦ã„ã‚‹ Lambda ã¯ Container å½¢å¼ã§ã®é…å¸ƒãªãŸã‚ Lambda Layer ã‚’ä½¿ãˆãªã„ã€‚[newrelic-lambda CLI quickstart](https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/enable-lambda-monitoring/instrument-your-own) ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ `nwerelic-lambda` ã‚‚ Lambda Layer ã‚’å‰æã¨ã—ã¦ã„ã‚‹ã®ã§åˆ©ç”¨ã§ããªã„ã€‚

AWS å…¬å¼ãƒ–ãƒ­ã‚°ã® [Working with Lambda layers and extensions in container images
](https://aws.amazon.com/jp/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/) ã«ã¯ Container å½¢å¼ã§ã®é…å¸ƒã§ã‚‚ Lambda Layer ã®æ‹¡å¼µã‚’åˆ©ç”¨ã™ã‚‹æ‰‹æ®µãŒè¤‡æ•°æ²è¼‰ã•ã‚Œã¦ã„ã‚‹ã€‚å±•é–‹ã®æ–¹æ³•ã¯ãã‚Œãã‚Œç•°ãªã‚‹ãŒã€ã©ã®æ–¹æ³•ã§ã‚‚ Container Image ã® `/opt` ã« Lambda Layer ã®å†…å®¹ã‚’å±•é–‹ã—ã¦ã„ã‚‹ã€‚

New Relic ã® Lambda Layer ã¯ã©ã®ã‚ˆã†ã«ä½œã‚‰ã‚Œã¦ã„ã‚‹ã‹ã€‚[Layer customization
](https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/enable-lambda-monitoring/instrument-your-own#cust) ã«ãƒªãƒ³ã‚¯ã®è¨˜è¼‰ãŒã‚ã‚‹é€šã‚Šã€GitHub ã®[newrelic/newrelic-lambda-layers](https://github.com/newrelic/newrelic-lambda-layers) ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ä½œã‚‰ã‚Œã¦ã„ã‚‹ã€‚README ã«ã¯ `extension/publish-layer.sh` ã‚’å®Ÿè¡Œã™ã‚‹ã¨å…¬é–‹ã•ã‚Œã‚‹ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¿ã‚‹ã¨ [`EXTENSION_DIST_URL_X86_64=https://github.com/newrelic/newrelic-lambda-extension/releases/download/v2.1.0/newrelic-lambda-extension.x86_64.zip`](https://github.com/newrelic/newrelic-lambda-layers/blob/v2.1.0_extension/extension/publish-layer.sh#L8) ã¨æ›¸ã‹ã‚Œã¦ãŠã‚Š `/opt` ã¸å±•é–‹ã™ã‚‹å…ƒã¨ãªã‚‹ zip ã¯ [newrelic/newrelic-lambda-extension](https://github.com/newrelic/newrelic-lambda-extension) ã‹ã‚‰å–å¾—ã•ã‚Œã¦ã„ã‚‹ã¨ã‚ã‹ã‚‹ã€‚ã“ã‚Œã‚’ç§ãŸã¡ã® Container Image ã® `/opt` ã¸å±•é–‹ã™ã‚Œã°ã‚ˆã„ã€‚

Lambda ã¸å±•é–‹ã™ã‚‹ã€ Go è¨€èªã«å¯¾å¿œã—ãŸ Container Image ã® Dockerfile ã¯

```Dockerfile
# You can find the latest container from https://gallery.ecr.aws/lambda/provided
ARG CONTAINER_NAME=public.ecr.aws/lambda/provided:al2.2022.02.01.09-x86_64

FROM ${CONTAINER_NAME} as newrelic-lambda-layer
# You can find the latest extention from https://github.com/newrelic/newrelic-lambda-layers/releases?q=%22New+Relic+Lambda+Extension%22&expanded=true
ENV EXTENTION_VERSION=v2.1.0
RUN mkdir -p /opt
RUN yum install -y unzip
RUN curl -OL https://github.com/newrelic/newrelic-lambda-extension/releases/download/${EXTENTION_VERSION}/newrelic-lambda-extension.x86_64.zip
RUN unzip newrelic-lambda-extension.x86_64.zip -d /opt

# Build go code
FROM ${CONTAINER_NAME} as build
# Install compiler
RUN yum install -y golang
RUN go env -w GOPROXY=direct
# Cache dependencies
ADD go.mod go.sum ./
RUN go mod download
# Build
ADD . .
RUN go build -o /main

# Copy artifacts to make a clean container image
FROM ${CONTAINER_NAME}
COPY --from=newrelic-lambda-layer /opt /opt
COPY --from=build /main /var/runtime/bootstrap

# CMD arguments is not be used on Go lambda.
# Though, provided:al2 image's entrypoint requires an argument as a handler name.
# So, we just pass empty string to work propely.
CMD [""]
```

ã¨ãªã‚‹ã€‚`newrelic-lambda-layer` ã¨ã„ã†ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã§ zip ã‚’è§£å‡ã—ã¦ `/opt` ã¸ç½®ãã€æœ€å¾Œã®ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã§ `COPY --from=newrelic-lambda-layer /opt /opt` ã¨ã„ã†å½¢å¼ã§ `newrelic-lambda-layer` ã® `/opt` ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã„ã‚‹éƒ¨åˆ†ã«æ³¨ç›®ã—ã¦ã»ã—ã„ã€‚

## `newrelic-lambda` ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ä½œã‚‰ã‚ŒãŸ SecretManager ã‚’ cdk ã‹ã‚‰åˆ©ç”¨ã™ã‚‹

[Continuous deployment](https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/enable-lambda-monitoring/instrument-your-own/#cont)

Lambda ã®æƒ…å ±ã‚’ New Relic ã«é€ã‚‹éš›ã«ã¯ New Relic ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID ã¨ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ãŒå¿…è¦ã«ãªã‚‹ã€‚`newrelic-lambda integrations install` ã‚’ä½¿ã£ãŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã—ãŸå ´åˆã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID ã¨ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã¯ AWS Secrets Manager ã« `NEW_RELIC_LICENSE_KEY` ã¨ã„ã†åå‰ã§ãƒªã‚½ãƒ¼ã‚¹ãŒä½œã‚‰ã‚Œã€ãã®ä¸­ã«ä¿æŒã•ã‚Œã¦ã„ã‚‹ã€‚

ã“ã®ãƒªã‚½ãƒ¼ã‚¹ã«ä¿æŒã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã‚’ Lambda ã‹ã‚‰åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€cdk ã«ä»¥ä¸‹ã®è¨˜è¿°ã‚’è¿½åŠ ã—ãŸã€‚
cdk ã§ã®ãƒªã‚½ãƒ¼ã‚¹ã®å–å¾—ã¨ã€Lambda ãŒãã®ãƒªã‚½ãƒ¼ã‚¹ã®å€¤ã‚’èª­ã¿å–ã‚Šã‚‹ãŸã‚ã®æ¨©é™ã®ä»˜ä¸ã§ã‚ã‚‹ã€‚

```typescript
// newrelic-lambda ãŒ AWS ä¸Šã«ä½œæˆã—ãŸ SecretManager ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹
const newrelicLicenseKeySecretManager = Secret.fromSecretNameV2(
  this,
  // id ã¯ cdk ã‚’æ›¸ããƒ—ãƒ­ã‚°ãƒ©ãƒãŒä»»æ„ã«ã¤ã‘ã¦ã‚ˆã„ã‚‚ã®
  "newrelic-license-key-secret-manager",
  // newrelic-lambda ã«ã¦ç”Ÿæˆã•ã‚ŒãŸåå‰ãªã®ã§å›ºå®šå€¤
  "NEW_RELIC_LICENSE_KEY"
);

// Conainer Image ã‚’ä½¿ã£ãŸ Lambda ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
const dockerImageFunction = new DockerImageFunction(...);

// SecretManager ã®å€¤ã‚’èª­ã¿å–ã‚Šå¯èƒ½ã¨ã™ã‚‹
newrelicLicenseKeySecretManager.grantRead(dockerImageFunction);
```

## Go è¨€èªã§ NewRelic ã‚’åˆ©ç”¨ã™ã‚‹

æœ€ã‚‚ç¶²ç¾…çš„ã«è¨˜è¿°ã•ã‚Œã¦ã„ãŸã®ã¯ [Legacy manual instrumentation for Lambda monitoring](https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/enable-lambda-monitoring/enable-serverless-monitoring-aws-lambda-legacy)ã® Go ã®é …ã ã£ãŸã€‚

> Install the agent: go get -u github.com/newrelic/go-agent/v3/newrelic.
> Install the nrlambda integration go get -u github.com/newrelic/go-agent/v3/integrations/nrlambda.
> In your Lambda code, import our components, create an application, and update how you start your Lambda. See our instrumentation examples:

ã«ã‚ã‚‹é€šã‚Šã€ã‚³ãƒãƒ³ãƒ‰ã§

```
go get -u github.com/newrelic/go-agent/v3/newrelic
go get -u github.com/newrelic/go-agent/v3/integrations/nrlambda
```

ã—ã¦ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å–å¾—ã—ã¦ã‹ã‚‰ main é–¢æ•°ã‚’

```go
func main() {
	app, err := newrelic.NewApplication(nrlambda.ConfigOption())
	if nil != err {
		fmt.Println("error creating app (invalid config):", err)
	}
	# lambda.Start(handler) ã‹ã‚‰å¤‰æ›´ã™ã‚‹
	nrlambda.Start(handler, app)
}
```

ã¨æ›¸ãã¨æœ€å°é™ï¼ˆã‹ã¤ååˆ†ï¼‰ãªè¨­å®šã®æº–å‚™ãŒã§ãã‚ãŒã‚‹ã€‚

> The following environment variables are not required for Lambda monitoring to function but they are required if you want your Lambda functions to be included in distributed traces. To enable distributed tracing, set these environment variables in the AWS console:
>
> NEW_RELIC_ACCOUNT_ID. Your account ID.
> NEW_RELIC_TRUSTED_ACCOUNT_KEY. This is also your account ID. If your account is a child account, this is the account ID for the root/parent account.

ã«ã‚ã‚‹ç’°å¢ƒå¤‰æ•° 2 ã¤ã¯ CDK ã§ä»¥ä¸‹ã®ã‚ˆã†ã«æ¸¡ã›ã‚‹ã€‚`newrelicAccountId` ã¨ `newrelicTrustedAccountKey` ã¯ã‚³ãƒ¼ãƒ‰ã®ä¸­ã«ç›´æ¥æ›¸ã„ã¦ã‚‚ã‚ˆã„ãŒã€ç§ã¯ cdk ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã« `cdk deploy --context newrelic-account-id=aaaa --context newrelic-trusted-account-key=bbbb` ã¨ã„ã†å½¢ã§æ¸¡ã—ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä¸­ã§ `tryGetContext` ã‚’ä½¿ã£ã¦å–å¾—ã—ãŸã€‚

```typescript
const newrelicAccountId = this.node.tryGetContext("newrelic-account-id") || "";
const newrelicTrustedAccountKey =
  this.node.tryGetContext("newrelic-trusted-account-key") || "";

const dockerImageFunction = new DockerImageFunction(
  this,
  "docker-image-function",
  {
    // ...
    environment: {
      NEW_RELIC_ACCOUNT_ID: newrelicAccountId,
      NEW_RELIC_TRUSTED_ACCOUNT_KEY: newrelicTrustedAccountKey,
    },
  }
);
```

# Lambda ã®ãƒ­ã‚°ã‚’é›†è¨ˆã™ã‚‹

[Step 2 (optional): Set up AWS CloudWatch log collection](https://docs.newrelic.com/docs/serverless-function-monitoring/aws-lambda-monitoring/enable-lambda-monitoring/set-up-cloudwatch-logs)

> if you used the newrelic-lambda CLI, that automatically installs an AWS CloudWatch logs collector by default.

ã¨æ›¸ã„ã¦ã‚ã‚‹ã®ã§ã€ãƒ­ã‚°é›†è¨ˆã®å‡¦ç†ã¯ä¸è¦ã‹ã¨æ€ã£ãŸãŒã€å®Ÿéš›ã«ã¯å¿…è¦ã ã£ãŸã€‚"AWS CloudWatch logs collector" ã¯è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã¨ã¯æ›¸ã„ã¦ã‚ã‚‹ã—ã€å®Ÿéš›ã«ã‚‚ `newrelic-log-ingestion` ã¨ã„ã† Lambda é–¢æ•°ãŒä½œã‚‰ã‚Œã¦ã„ãŸãŒã€è¨­å®šã¯è‡ªåˆ†ãŸã¡ã§è¡Œã†ã¨ã„ã†ã“ã¨ãªã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚

ã¾ãš `newrelic-log-ingestion` Lambda é–¢æ•°ã®ç’°å¢ƒå¤‰æ•°ã® `LOGGING_ENABLED` ãŒ `true` ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã€ãªã£ã¦ã„ãªã‘ã‚Œã°å¤‰ãˆã‚‹ã€‚è¨˜æ†¶ãŒå®šã‹ã§ã¯ãªã„ãŒã€æ‰‹å…ƒã§ä½œã£ãŸã¨ãã«ã¯ãªã£ã¦ã„ãªã‹ã£ãŸã®ã§å¤‰ãˆãŸã‚ˆã†ãªæ°—ãŒã™ã‚‹ã€‚å„ç’°å¢ƒå¤‰æ•°ã®è¨­å®šå€¤ã¯ [Install and configure the Cloudwatch logs Lambda function](https://docs.newrelic.com/docs/logs/forward-logs/aws-lambda-sending-cloudwatch-logs/#install-function) ã«è¨˜è¼‰ãŒã‚ã‚‹ã€‚

æ¬¡ã« [Create a Lambda trigger](https://docs.newrelic.com/docs/logs/forward-logs/aws-lambda-sending-cloudwatch-logs/#create-trigger) ã«ã‚ã‚‹é€šã‚Šã€`nwrelic-log-ingestion` Lambda é–¢æ•°ã®ãƒˆãƒªã‚¬ãƒ¼ã¸ã€é€ã‚ŠãŸã„ Lambda ã® CloudWatch ãƒ­ã‚°ã‚’æŒ‡å®šã™ã‚‹ã€‚ã“ã®æ–‡ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ“ä½œã—ãŸå ´åˆã®æ–¹æ³•ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’ CDK ã§è¡Œã†æ–¹æ³•ã«èª­ã¿æ›¿ãˆã‚‹ã€‚

```typescript
// newrelic-lambda ãŒ AWS ä¸Šã«ä½œæˆã—ãŸ AWS Lambda ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹
// é–¢æ•°ã®åå‰ã¯ `newrelic-log-ingestion` ã¨æ±ºã¾ã£ã¦ã„ã‚‹ã®ã§ã€arn ã¯ãã“ã‹ã‚‰ä½œæˆå¯èƒ½
// ARN ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ https://docs.aws.amazon.com/quicksight/latest/APIReference/qs-arn-format.html ã‚’å‚ç…§
const newrelicLogIngestionArn = `arn:aws:lambda:${this.region}:${this.account}:function:newrelic-log-ingestion`;
const newrelicLogIngestion = Function.fromFunctionArn(
  this,
  "newrelic-log-ingestion",
  newrelicLogIngestionArn
);

// Conainer Image ã‚’ä½¿ã£ãŸ Lambda ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
const dockerImageFunction = new DockerImageFunction(...);

// newrelic-log-ingestion Lambda é–¢æ•°ã¸ã€dockerImageFunction ã®ãƒ­ã‚°ã‚’é€ã‚‹
// "docker-image-function-logfilter" ã¨ã„ã† id ã¯ cdk ã‚’æ›¸ããƒ—ãƒ­ã‚°ãƒ©ãƒãŒä»»æ„ã«ã¤ã‘ã¦ã‚ˆã„ã‚‚ã®
dockerImageFunction.logGroup.addSubscriptionFilter("docker-image-function-logfilter", {
  destination: new LambdaDestination(newrelicLogIngestion),
  // ã‚‚ã—é€ã‚‹ãƒ­ã‚°ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãŸã„å ´åˆã¯ã“ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¤‰æ›´ã™ã‚‹
  filterPattern: FilterPattern.allEvents(),
});
```

# ã¾ã¨ã‚

AWS CDK ã‚’ä½¿ã£ã¦ Container Image å½¢å¼ã§é…å¸ƒã—ãŸ Go è¨€èªã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ AWS Lambda ã®ç›£è¦–ã‚’ New Relic ã§è¡Œã†ã¨ãã«ã¤ã¾ã¥ãç‚¹ã«ã¤ã„ã¦æ›¸ã„ãŸã€‚

CDK ã¯æœ€çµ‚çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã«ãªã‚‹ã€‚

```typescript
export class CdkStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const newrelicAccountId =
      this.node.tryGetContext("newrelic-account-id") || "";
    const newrelicTrustedAccountKey =
      this.node.tryGetContext("newrelic-trusted-account-key") || "";

    // newrelic-lambda ãŒ AWS ä¸Šã«ä½œæˆã—ãŸ SecretManager ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹
    const newrelicLicenseKeySecretManager = Secret.fromSecretNameV2(
      this,
      // id ã¯ cdk ã‚’æ›¸ããƒ—ãƒ­ã‚°ãƒ©ãƒãŒä»»æ„ã«ã¤ã‘ã¦ã‚ˆã„ã‚‚ã®
      "newrelic-license-key-secret-manager",
      // newrelic-lambda ã«ã¦ç”Ÿæˆã•ã‚ŒãŸåå‰ãªã®ã§å›ºå®šå€¤
      "NEW_RELIC_LICENSE_KEY"
    );

    // newrelic-lambda ãŒ AWS ä¸Šã«ä½œæˆã—ãŸ AWS Lambda ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹
    // é–¢æ•°ã®åå‰ã¯ `newrelic-log-ingestion` ã¨æ±ºã¾ã£ã¦ã„ã‚‹ã®ã§ã€arn ã¯ãã“ã‹ã‚‰ä½œæˆå¯èƒ½
    // ARN ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ https://docs.aws.amazon.com/quicksight/latest/APIReference/qs-arn-format.html ã‚’å‚ç…§
    const newrelicLogIngestionArn = `arn:aws:lambda:${this.region}:${this.account}:function:newrelic-log-ingestion`;
    const newrelicLogIngestion = Function.fromFunctionArn(
      this,
      "newrelic-log-ingestion",
      newrelicLogIngestionArn
    );

    // Conainer Image ã‚’ä½¿ã£ãŸ Lambda ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
    const dockerImageFunction = new DockerImageFunction(
      this,
      "docker-image-function",
      {
        // ...
        environment: {
          NEW_RELIC_ACCOUNT_ID: newrelicAccountId,
          NEW_RELIC_TRUSTED_ACCOUNT_KEY: newrelicTrustedAccountKey,
        },
      }
    );

    // SecretManager ã®å€¤ã‚’èª­ã¿å–ã‚Šå¯èƒ½ã¨ã™ã‚‹
    newrelicLicenseKeySecretManager.grantRead(dockerImageFunction);

    // newrelic-log-ingestion Lambda é–¢æ•°ã¸ã€dockerImageFunction ã®ãƒ­ã‚°ã‚’é€ã‚‹
    // "docker-image-function-logfilter" ã¨ã„ã† id ã¯ cdk ã‚’æ›¸ããƒ—ãƒ­ã‚°ãƒ©ãƒãŒä»»æ„ã«ã¤ã‘ã¦ã‚ˆã„ã‚‚ã®
    dockerImageFunction.logGroup.addSubscriptionFilter(
      "docker-image-function-logfilter",
      {
        destination: new LambdaDestination(newrelicLogIngestion),
        // ã‚‚ã—é€ã‚‹ãƒ­ã‚°ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãŸã„å ´åˆã¯ã“ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¤‰æ›´ã™ã‚‹
        filterPattern: FilterPattern.allEvents(),
      }
    );
  }
}
```
