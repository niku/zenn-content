---
title: "Packerã‚’ä½¿ã£ã¦Vagrantã®Boxã‚’ä½œã‚‹æ–¹æ³•ã‚’ä¸€ã¤ãšã¤èª¬æ˜ã™ã‚‹"
emoji: "ğŸ“Œ"
type: "tech"
topics: []
published: false
---

Packer ã‚’ä½¿ã£ã¦ Vagrant ã® Box ã‚’ OS ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‹ã‚‰ä½œæˆã§ããŸã®ã§ã€ä¸€ã¤ãšã¤èª¬æ˜ã™ã‚‹ã€‚

ã‚³ãƒ¼ãƒ‰ã¯ github ã® [niku/my-packer-and-vagrant-example](https://github.com/niku/my-packer-and-vagrant-example/) ã«ã‚ã‚‹ã€‚

## èª­ã‚€ã¨æ‰‹ã«å…¥ã‚‹ã‚‚ã®

`packer build wheezy64.json`
ã¨å®Ÿè¡Œã™ã‚‹ã ã‘ã§
ã€Œchef-solo ãŒå®Ÿè¡Œå¯èƒ½ãª Vagrant ç”¨ Box ã‚’ OS ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‹ã‚‰å…¨è‡ªå‹•ã§ä½œæˆã—ã¦ãã‚Œã‚‹ç’°å¢ƒã€
ã®ä½œã‚Šæ–¹ã€‚

å•é¡Œã«ã‚ãŸã£ãŸã¨ãã«ã€ã©ã†ã„ã†ã¨ã“ã‚ã‚’å‚è€ƒã«ã—ãŸã‚‰ã‚ˆã„ã‹ã€ãŒã‚ã‹ã‚‹ã€‚(ã‚ˆã†ã«æ›¸ããŸã„ã¨è€ƒãˆã¦ã„ã‚‹)

## èª­ã‚“ã§ã‚‚æ‰‹ã«å…¥ã‚‰ãªã„ã‚‚ã®

1. VirtualBox/Vagrant/Packer ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
2. Vagrant Box ä½œæˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

2 ã«ã¤ã„ã¦ã¯ [veewee/templates](https://github.com/jedi4ever/veewee/tree/master/templates) ä»¥ä¸‹ã‚’è¦‹ã‚‹ã®ãŒã‚ˆã„ã€‚ä»Šå›ã‚‚ã‹ãªã‚Šå‚è€ƒã«ã•ã›ã¦ã‚‚ã‚‰ã£ãŸã€‚

## å¿…è¦ãªã‚½ãƒ•ãƒˆ

- [[https://www.virtualbox.org/][VirtualBox]]
- [[http://www.vagrantup.com/][Vagrant]]
- [[http://www.vagrantup.com/][Packer]]

ãƒ›ã‚¹ãƒˆ OS ã¯ windows10 ã§ã‚ã‚‹ã€‚

#+BEGIN_HTML
<del datetime="2014-04-04T16:30:00+09:00">
ä»Šå›ã¯ VirtualBox4.2.16 / Vagrant1.2.7 / Packer 0.2.3 ã§è¡Œãªã£ãŸã€‚

Packer ã¯ç¾åœ¨ (2013/08/20) æœ€æ–°ç‰ˆãŒä¸å®‰å®šãªã“ã¨ãŒã‚ã‚‹ã®ã§ã€æœ€æ–°ç‰ˆã§è©¦ã—ã¦ã¿ã¦ã€ã†ã¾ãã„ã‹ãªã‘ã‚Œã° 0.2.3 ã¸ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã¿ã‚‹ã¨ã‚ˆã„ã€‚

åƒ•ãŒ 0.3.x ç³»ã‚’è©¦ã—ãŸã¨ãã«ã¯ã„ãã¤ã‹ä¸å®‰å®šãªæŒ™å‹•ã‚’ã—ãŸã€‚0.2.3 ã§ã¯ãã®ã‚ˆã†ãªã“ã¨ã¯ãŠããªã‹ã£ãŸã€‚
</del>
#+END_HTML

#+BEGIN_HTML
<p><ins datetime="2014-04-04T16:30:00+09:00">
2014-04-04ç¾åœ¨ã®æœ€æ–°ç‰ˆã§ã‚ã‚‹VirtualBox4.3.10 / Vagrant1.5.1 / Packer 0.5.2ã§æ­£å¸¸ã«å‹•ä½œã—ãŸã€‚
</ins></p>
#+END_HTML

## 0. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè§£æã«å¤±æ•—ã™ã‚‹

ä»¥é™ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å…¨ã¦ my-packer-and-vagrant-template ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä½œæ¥­ã—ã¦ã„ã‚‹ã€‚

```
$ packer build wheezy64.json
Failed to parse template: open wheezy.json: no such file or directory
```

ã¾ã ä½•ã‚‚ç”¨æ„ã—ã¦ã„ãªã„ã®ã§å½“ç„¶ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

æœ€å°é™ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”¨æ„ã™ã‚‹ã€‚

[[http://www.packer.io/docs/templates/introduction.html][TEMPLATES]] ã«ã¯ builders ãŒå¿…é ˆ (required)ã€[[http://www.packer.io/docs/builders/virtualbox.html][VirtualBox Builder]] ã«ã¯
- iso_checksum_type
- iso_checksum
- iso_url
- ssh_username
ãŒå¿…é ˆ (required) ã¨æ›¸ã„ã¦ã‚ã‚‹ã®ã§ã€æº–å‚™ã™ã‚‹ã€‚

[[https://github.com/niku/my-packer-and-vagrant-example/commit/7171bf7417fb8464fa2aab8044a351a05eef6d3d][7171bf7417fb8464fa2aab8044a351a05eef6d3d]] ã®ã‚ˆã†ã«ãªã‚‹ã€‚

#+BEGIN_HTML
<ins datetime="2014-04-04T15:33:00+09:00">packer0.5.0ã‹ã‚‰typeåã¯virtualboxã§ã¯ãªãvirtualbox-isoã«ãªã£ãŸã€‚<a href="https://github.com/niku/my-packer-and-vagrant-example/commit/271a734d8953e89ab15ca24959bcf3194961e22c">271a734d8953e89ab15ca24959bcf3194961e22c</a>å‚ç…§ã®ã“ã¨</ins>
#+END_HTML

## 1. ãƒ–ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§æ­¢ã¾ã‚‹

`$ packer build wheezy64.json`

ã™ã‚‹ã¨ã€Debian ã® ISO ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦

[[01-stop-at-boot-menu.png]]

ã®ã‚ˆã†ã«ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã™ã‚‹ã€‚ã—ã‹ã—ãã“ã‹ã‚‰ã¯ä½•ã‚‚é€²ã¾ãªã„ã€‚

å¤§æŠµã® OS ã«ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ãŠãã¨è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é€²ã‚ã¦ãã‚Œã‚‹ã‚ˆã†ãªæ©Ÿèƒ½ãŒå‚™ã‚ã£ã¦ãŠã‚Šã€
Packer ã§ã¯ãã‚Œã‚’åˆ©ç”¨ã—ã¦ OS ã®è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é€²ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

ãã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€æœ€åˆã« Boot Command ã¨ã„ã†ã®ã‚‚ã®ã‚’å…¥åŠ›ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ãŒã€ã™ãã«ç†è§£ã™ã‚‹ã®ã¯é›£ã—ã„ã€‚
ãã“ã§ [[https://github.com/jedi4ever/veewee/tree/master/templates][veewee ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ]] ã‚’æµç”¨ã•ã›ã¦ã‚‚ã‚‰ã†ã“ã¨ã«ã™ã‚‹ã€‚ãƒªãƒ³ã‚¯å…ˆã‚’è¦‹ã¦ã‚ã‹ã‚‹ã‚ˆã†ã«ä¸»è¦ãª OS ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯æƒã£ã¦ã„ã‚‹ã€‚

[[https://github.com/jedi4ever/veewee/blob/master/templates/Debian-7.1.0-amd64-netboot/definition.rb][veewee ã® definition.rb]] ã‚’é–‹ãã¨ã€:boot_cmd_sequence ã¨ã„ã†é …ç›®ãŒã‚ã‚‹ã€‚ãã®éƒ¨åˆ†ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦

1. JSON ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ãŸã‚ã« '( ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ ) ã‚’ "( ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ ) ã«å¤‰æ›´
2. Packer ã®ã‚­ãƒ¼ã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ãƒˆã«ã‚ã‚ã›ã¦ <Abc> ã‚’ <abc> ã®ã‚ˆã†ã«å¤‰æ›´
3. Packer ã®å¤‰æ•°ã«ã‚ã‚ã›ã¦ %IP% ã‚’ {{ .HTTPIP }} ã®ã‚ˆã†ã«å¤‰æ›´

ã® 3 ã¤ã‚’è¡Œã£ãŸã€‚

Packer ã® Boot Command ã®è©³ç´°ã¯ [[http://www.packer.io/docs/builders/virtualbox.html][VirtualBox Builder]] ã«è¨˜è¿°ãŒã‚ã‚‹ã€‚

[[https://github.com/niku/my-packer-and-vagrant-example/commit/965428a5ced59ace6ce772d8caee42cd86f34a11][965428a5ced59ace6ce772d8caee42cd86f34a11]] ã®ã‚ˆã†ã«ãªã‚‹ã€‚

## 2. ãƒ–ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰å…¥åŠ›ä¸­ã«æ­¢ã¾ã‚‹

å‰å›ã¨åŒã˜ã‚ˆã†ã«

`$ packer build wheezy64.json -force`

ã™ã‚‹ã¨ã€ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã™ã‚‹ã€‚(force ã¯ã€[[http://www.packer.io/docs/command-line/build.html][ä½œã‚Šã‹ã‘ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å¼·åˆ¶çš„ã«ä¸Šæ›¸ãã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³]])

10 ç§’ãã‚‰ã„å¾…ã¤ã¨ç”»é¢ãŒåˆ‡ã‚Šæ›ã‚ã£ã¦ã€æ–‡å­—ã‚’å…¥åŠ›ã—ã¯ã˜ã‚ã‚‹ãŒã€å›³ã®ã‚ˆã†ãªçŠ¶æ…‹ã§æ­¢ã¾ã£ã¦ã—ã¾ã†ã€‚

[[02-stop-at-boot-command.png]]

i ãŒå…¥åŠ›ã•ã‚Œã¦ãŠã‚‰ãš install ã§ã¯ãªã nstall ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ã›ã„ã§ã‚ã‚‹ã€‚

Boot Command ã¯ã‚­ãƒ¼å…¥åŠ›ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦ã„ã‚‹ã®ã§ã€Œç”»é¢ãŒåˆ‡ã‚Šæ›ã‚ã£ãŸã‚‰ã€ã¨ã„ã†å‡¦ç†ã«ã¯å¯¾å¿œã—ã¦ã„ãªã„ã€‚(ç”»é¢ã‚’è¦‹ãšã«ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã„ã‚‹ã®ã¨åŒã˜)

ãã“ã§ã€ãƒ–ãƒ¼ãƒˆç”»é¢èµ·å‹• -> 10 ç§’ãã‚‰ã„å¾…ã¤ -> Esc ã‚’æŠ¼ã™ -> install ã‚’å…¥åŠ›ã™ã‚‹ã®ã‚ã„ã ã«ã‚¦ã‚§ã‚¤ãƒˆå‡¦ç†ã‚’å…¥ã‚Œã€ãƒ–ãƒ¼ãƒˆç”»é¢èµ·å‹• -> 10 ç§’ãã‚‰ã„å¾…ã¤ -> Esc ã‚’æŠ¼ã™ -> 1 ç§’å¾…ã¤ -> install ã¨ã™ã‚‹ã€‚

ã‚­ãƒ¼å…¥åŠ›ã®ã‚¦ã‚§ã‚¤ãƒˆåˆ¶å¾¡ã¯ [[http://www.packer.io/docs/builders/virtualbox.html][Boot Command ã® <wait>]] ã§è¡Œã†ã€‚ä»Šå›ã®è‡ªåˆ†ã®ç’°å¢ƒã§ã¯èµ·ã“ã‚‰ãªã‹ã£ãŸãŒã€ã‚‚ã—ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã™ã‚‹å‰ã«ã‚­ãƒ¼å…¥åŠ›ãŒå§‹ã¾ã£ã¦ã—ã¾ã†å ´åˆã¯ [[http://www.packer.io/docs/builders/virtualbox.html][boot_wait]] ã®æ™‚é–“ã‚’ä¼¸ã°ã—ã¦ã¿ã‚‹ã¨ã‚ˆã„ã€‚

å·®åˆ†ã¯ [[https://github.com/niku/my-packer-and-vagrant-example/commit/6a29e4df31e804c93672ad8e5ea37ca4f0852884][6a29e4df31e804c93672ad8e5ea37ca4f0852884]] ã®ã‚ˆã†ã«ãªã‚‹ã€‚

## 3. ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ããªãã¦æ­¢ã¾ã‚‹

`$ packer build wheezy64.json -force`

ã™ã‚‹ã¨ã€ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã—ã¦ã€ãƒ–ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã€ã‚¨ãƒ©ãƒ¼ç”»é¢ã«ãªã‚‹ã€‚

[[03-fail-at-download-debconf-preconfiguration-file.png]]

OS ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã™ã‚‹éš›ã€ã„ãã¤ã‹è¨­å®šãŒå¿…è¦ã§ã‚ã‚‹ã€‚OS ã‚’è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã«ã¯ã€ãã‚Œã‚‰ã®è¨­å®šã‚’è‡ªå‹•ã§è¡Œã†å¿…è¦ãŒã‚ã‚‹ã€‚å„ OS ã«ã¯ã€ãŸã„ã¦ã„è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨ã®è¨­å®šã‚’å–å¾—ã™ã‚‹æ–¹æ³•ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚

Packer ã§ã¯è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒç°¡å˜ã«ã§ãã‚‹ã‚ˆã†ã«ã€ã„ãã¤ã‹ã®ä»•çµ„ã¿ã‚’ç”¨æ„ã—ã¦ã„ã‚‹ã€‚

Debian, Ubuntu, CentOS ãªã©ã§ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¶Šã—ã«è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®è¨­å®šãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
Packer ã¯ HTTP ã‚µãƒ¼ãƒãƒ¼ã«ãªã‚‹æ©Ÿèƒ½ã‚’ã‚‚ã£ã¦ã„ã¦ã€[[http://www.packer.io/docs/builders/virtualbox.html][http_directory]] ã‚’æŒ‡å®šã™ã‚Œã°ã€ãã®ä¸‹ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ HTTP ã‚µãƒ¼ãƒãƒ¼è¶Šã—ã«å–å¾—ã§ãã‚‹ã€‚

Windows ã§ã¯ãƒ•ãƒ­ãƒƒãƒ”ãƒ¼ãƒ‡ã‚£ã‚¹ã‚¯ã‹ã‚‰è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®è¨­å®šãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
Packer ã¯ãƒ•ãƒ­ãƒƒãƒ”ãƒ¼ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹æ©Ÿèƒ½ã‚’ã‚‚ã£ã¦ã„ã¦ã€[[http://www.packer.io/docs/builders/virtualbox.html][floppy_files]] ã‚’æŒ‡å®šã™ã‚Œã°ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ãƒ­ãƒƒãƒ”ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–è¶Šã—ã«å–å¾—ã§ãã‚‹ã€‚

ä»Šå›ã¯ Debian ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã®ã§ http_directory ã‚’æŒ‡å®šã—ã¦ã€ãã“ã«è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®è¨­å®šã‚’ç½®ã„ãŸã€‚
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãæ–¹ã‚„ã‚µãƒ³ãƒ—ãƒ«ã¯å„ OS ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã¯ãšãªã®ã§ã€ãã“ã‹ã‚‰æ¢ã™ã€‚
ä»Šå›ã®å ´åˆã ã¨[[http://www.debian.org/releases/stable/amd64/apbs04.html.ja][äº‹å‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ (wheezy ç”¨)]] ã¨ã„ã†ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒã« [[http://www.debian.org/releases/wheezy/example-preseed.txt]] ã‹ã‚‰å–å¾—ã—ã¦ããŸã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/0405ae17533c3eb2a959f4223594a7c99f0c3ed5][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/0405ae17533c3eb2a959f4223594a7c99f0c3ed5][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 4. ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å¾…ã¡ã§æ­¢ã¾ã‚‹

`$ packer build wheezy64.json -force`

ã™ã‚‹ã¨ã€ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã—ã¦ã€ãƒ–ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã€ã—ã°ã‚‰ãå¾…ã¤ã¨ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ã«ãªã£ã¦æ­¢ã¾ã‚‹ã€‚

[[04-stop-at-input-root-password.png]]

ã“ã“ã‹ã‚‰ã¯[[http://www.debian.org/releases/stable/amd64/apbs04.html.ja][äº‹å‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã®èª¬æ˜]]ã€äº‹å‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã„ã¦ã‚ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã€ã‚°ãƒ¼ã‚°ãƒ«ã€å‹˜ã® 4 ã¤ã‚’é§†ä½¿ã—ã¦ä½œæ¥­ã‚’é€²ã‚ã‚‹ã€‚
ã“ã“ã«ã¯æ­£è§£ãƒ«ãƒ¼ãƒˆãŒã‚¹ãƒ©ã‚¹ãƒ©ã¨æ›¸ã„ã¦ã‚ã‚‹ã®ã§ã€å…¨ç„¶æ‚©ã¾ãªã‹ã£ãŸã‚ˆã†ã«ã¿ãˆã‚‹ã ã‚ã†ãŒã€å®Ÿéš›ã«ã¯å¤šå°‘æ‚©ã¿ãªãŒã‚‰è¡Œãã¤æˆ»ã‚Šã¤ä½œæ¥­ã—ã¦ã„ãŸã€‚
ã‚‚ã—ã†ã¾ãã„ã‹ãªãã¦ã‚‚ã€ã‚³ãƒãƒ³ãƒ‰ä¸€ã¤ã§å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ãã‚‹ã®ã§ã€æ°—æ¥½ã«å¤‰æ›´ã—ã¦ã¿ã‚‹ã¨ã‚ˆã„ã€‚

ç”»é¢ã®å†…å®¹ã‚’è¦‹ã‚‹ã¨ã€root password ã®å…¥åŠ›ãŒå¿…è¦ã‚‰ã—ã„ã€‚äº‹å‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª¬æ˜ã‚’ password ã§æ¤œç´¢ã™ã‚‹ã¨ã€B.4.5 ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã¨ã„ã†ã®ãŒã‚ã‚‹ã®ã§ã€ã“ã‚Œã ã‚ã†ã€‚

ä»Šå›ã¯ã€Debian ã§ã‚ˆãã‚ã‚‹ root ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãªã„ï¼ˆã‹ã‚ã‚Šã«å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® sudo æ¨©é™ã§æ“ä½œã™ã‚‹ï¼‰ã¨ã„ã†æ–¹å¼ã«ã—ã‚ˆã†ã¨æ€ã†ã®ã§

`#d-i passwd/root-login boolean false`
ã‚’
`d-i passwd/root-login boolean false`
ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã™ã‚‹ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/858351d5dc0403e306dc0d6b600a6b9a21bd3069][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/858351d5dc0403e306dc0d6b600a6b9a21bd3069][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼å ( ãƒ•ãƒ«ãƒãƒ¼ãƒ  ) å…¥åŠ›å¾…ã¡ã§æ­¢ã¾ã‚‹

`$ packer build wheezy64.json -force`

ã™ã‚‹ã¨ã€ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã—ã¦ã€ãƒ–ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã€ã—ã°ã‚‰ãå¾…ã¤ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å ( ãƒ•ãƒ«ãƒãƒ¼ãƒ  ) å…¥åŠ›ç”»é¢ã«ãªã£ã¦æ­¢ã¾ã‚‹ã€‚

[[05-stop-at-input-user-full-name.png]]

"4. ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å¾…ã¡ã§æ­¢ã¾ã‚‹" ã¨åŒæ§˜ã«ã€äº‹å‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª¬æ˜ B.4.5 ã‚’ã¿ã¦

`#d-i passwd/user-fullname string Debian User`
ã‚’
`d-i passwd/user-fullname string Vagrant User`
ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã™ã‚‹ã€‚

å¾Œè¿°ã™ã‚‹ã‚ˆã†ã« [[http://docs-v1.vagrantup.com/v1/docs/base_boxes.html][Vagrant ãŒæœŸå¾…ã™ã‚‹åˆæœŸå€¤ ( Convention over Configration ã‚’å‚ç…§ã®ã“ã¨ )]] ã¯ã‚ã‚‹ã€‚ã—ã‹ã—ãƒ•ãƒ«ãƒãƒ¼ãƒ ã¯ç‰¹ã«æ±ºã¾ã£ã¦ã„ãªã„ã‚ˆã†ãªã®ã§ã€é©å½“ã«åä»˜ã‘ã¦ã‚ˆã„ã€‚

## 6. ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›å¾…ã¡ã§æ­¢ã¾ã‚‹

`$ packer build wheezy64.json -force`

ã™ã‚‹ã¨ã€ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã—ã¦ã€ãƒ–ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã€ã—ã°ã‚‰ãå¾…ã¤ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›ç”»é¢ã«ãªã£ã¦æ­¢ã¾ã‚‹ã€‚

[[06-stop-at-input-username.png]]

å¾Œã§ä½¿ã† [[http://docs-v1.vagrantup.com/v1/docs/base_boxes.html][Vagrant ã§ã¯åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã«æŒ‡å®šãŒã‚ã‚‹ ( Convention over Configration ã‚’å‚ç…§ã®ã“ã¨ )]] ã®ã§ã€ãã‚Œã«å¾“ã„ vagrant ã¨åä»˜ã‘ã‚‹ã“ã¨ã«ã™ã‚‹ã€‚

`#d-i passwd/username string debian`
ã‚’
`d-i passwd/username string vagrant`
ã«ã™ã‚‹ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/ac93354afa53fe3df9c44574f7723e0da10024ad][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/ac93354afa53fe3df9c44574f7723e0da10024ad][å‰å›ã‹ã‚‰ã®å·®åˆ†]]


## 7. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å¾…ã¡ã§æ­¢ã¾ã‚‹

`$ packer build wheezy64.json -force`

ã™ã‚‹ã¨ã€ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã—ã¦ã€ãƒ–ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã€ã—ã°ã‚‰ãå¾…ã¤ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ã«ãªã£ã¦æ­¢ã¾ã‚‹ã€‚

[[07-stop-at-input-password.png]]

[[http://docs-v1.vagrantup.com/v1/docs/base_boxes.html][Vagrant ã§ã¯åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«æŒ‡å®šãŒã‚ã‚‹ ( Convention over Configration ã‚’å‚ç…§ã®ã“ã¨ )]] ã®ã§ã€ãã‚Œã«å¾“ã„ vagrant ã¨åä»˜ã‘ã‚‹ã“ã¨ã«ã™ã‚‹ã€‚

`#d-i passwd/user-password password insecure`
ã‚’
`d-i passwd/user-password password vagrant`
ã«ã™ã‚‹ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/3d97b15dc57ab27b0f1f2553b768f25fb979599b][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/3d97b15dc57ab27b0f1f2553b768f25fb979599b][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 8. å†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å¾…ã¡ã§æ­¢ã¾ã‚‹

`$ packer build wheezy64.json -force`

ã™ã‚‹ã¨ã€ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã—ã¦ã€ãƒ–ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã€ã—ã°ã‚‰ãå¾…ã¤ã¨å†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ã«ãªã£ã¦æ­¢ã¾ã‚‹ã€‚

[[08-stop-at-input-password-verify.png]]

å½“ç„¶ "7. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å¾…ã¡ã§æ­¢ã¾ã‚‹" ã¨åŒã˜ã‚‚ã®ã‚’è¨­å®šã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ ( ã¯ãšã€‚è©¦ã—ã¦ã¯ã„ãªã„â€¦â€¦ ) ã®ã§ vagrant ã¨å…¥åŠ›ã™ã‚‹ã€‚

`#d-i passwd/user-password-again password insecure`
ã‚’
`d-i passwd/user-password-again password vagrant`
ã«ã™ã‚‹ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/18f78b2779d85b8b3c063a360e093203610abc88][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/18f78b2779d85b8b3c063a360e093203610abc88][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 9. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸äººæ°—æŠ•ç¥¨å‚åŠ é¸æŠå¾…ã¡ã§æ­¢ã¾ã‚‹

`$ packer build wheezy64.json -force`

ã™ã‚‹ã¨ã€ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã—ã¦ã€ãƒ–ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã€ã—ã°ã‚‰ãå¾…ã¤ã¨[[http://popcon.debian.org/][ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸äººæ°—æŠ•ç¥¨]]å‚åŠ é¸æŠå¾…ã¡ã§æ­¢ã¾ã‚‹ã€‚

[[09-stop-at-choose-to-participate-popularity-contest.png]]

ï¼ˆæ–‡å­—ãŒãã¡ã‚ƒã£ã¨ãªã‚‹ã®ãŒæ°—ã«ãªã‚‹ãŒåŸå› ã¯èª¿ã¹ã¦ã„ãªã„ã€‚èª­ã‚ã¯ã™ã‚‹ã®ã§ä»Šå›ã¯æ°—ã«ã—ãªã„ã“ã¨ã«ã—ãŸï¼‰

äººæ°—æŠ•ç¥¨ã¯ debian ãŒã€ã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒäººæ°—ã‹èª¿ã¹ã¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨ CD ã® 1 æšç›®ã«å…¥ã‚Œã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ±ºã‚ãŸã‚Šã™ã‚‹ã®ã«ä½¿ã†ã€‚
é€±ã« 1 å›ã®é€ä¿¡ã§ã€ã‹ã¤åŒ¿åãªã®ã§å‚åŠ ã—ã¦ã‚‚ã‹ã¾ã‚ãªã„ã®ã ãŒã€ä»Šå›ã¯å‚åŠ ã—ãªã„ã“ã¨ã«ã™ã‚‹ã€‚

[[https://github.com/niku/my-packer-and-vagrant-example/blob/18f78b2779d85b8b3c063a360e093203610abc88/preseed.cfg][preseed.cfg]] ã‚’ popularity ã§æ¤œç´¢ã™ã‚‹ã¨
`#popularity-contest popularity-contest/participate boolean false`
ã¨ã„ã†ã€ãã‚Œã‚‰ã—ã„ã‚‚ã®ãŒæ¤œç´¢ã«ã²ã£ã‹ã‹ã‚‹ã€‚

ã“ã‚Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦
`popularity-contest popularity-contest/participate boolean false`
ã«ã™ã‚‹ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/e33b1caa6f4801d1d8ce7b491a75cda019393b4e][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/e33b1caa6f4801d1d8ce7b491a75cda019393b4e][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 10. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¿ã‚¹ã‚¯ã®é¸æŠå¾…ã¡ã§æ­¢ã¾ã‚‹

`$ packer build wheezy64.json -force`

ã™ã‚‹ã¨ã€ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã—ã¦ã€ãƒ–ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã€ã—ã°ã‚‰ãå¾…ã¤ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¿ã‚¹ã‚¯ã®é¸æŠå¾…ã¡ã§æ­¢ã¾ã‚‹ã€‚

[[10-stop-at-choose-software-to-install.png]]

ä»Šå›ã¯ãƒŸãƒ‹ãƒãƒ«ã‚’ç›®æŒ‡ã—ã¦ã€ä½•ã‚‚å«ã‚ãªã„ã§é€²ã‚ã‚‹ã“ã¨ã«ã—ã¦ã„ã‚‹ã®ã§ã€‚[[http://www.debian.org/releases/stable/amd64/apbs04.html.ja][B.4. äº‹å‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ (wheezy ç”¨) - B.4.10. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é¸æŠ]] ã‚’å‚è€ƒã«ã—ã¦ã€
`#tasksel tasksel/first multiselect standard, web-server`
ã‚’
`tasksel tasksel/first multiselect`
ã¸å¤‰æ›´ã—ãŸã€‚ã€Œä½•ã‚‚å«ã‚ãªã„ã€ã¨ã„ã†æŒ‡å®šã®æ–¹æ³•ã¯ç©ºæ¬„ã§ã‚ˆã„ã‚ˆã†ã ã€‚

( ã‚ã‚‰ãŸã‚ã¦å‚è€ƒæ–‡çŒ®ã‚’èª­ã‚€ã¨ã€Œstandard ã‚¿ã‚¹ã‚¯ã¯å¸¸ã«å«ã‚ã‚‹ã®ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€ã¨æ›¸ã„ã¦ã‚ã£ãŸã®ã§ã€standardãã‚‰ã„ã¯å«ã‚ã¦ãŠã„ã¦ã‚‚ã‚ˆã‹ã£ãŸãªã¨ã€ä»Šã¯æ€ã£ã¦ã„ã‚‹ )

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/b10d3e8564776fc71fe3550cf7fc39de69f48cea][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/b10d3e8564776fc71fe3550cf7fc39de69f48cea][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 11. ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‹ã®é¸æŠå¾…ã¡ã§æ­¢ã¾ã‚‹

`$ packer build wheezy64.json -force`

ã™ã‚‹ã¨ã€ãƒ–ãƒ¼ãƒˆç”»é¢ãŒèµ·å‹•ã—ã¦ã€ãƒ–ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã€ã—ã°ã‚‰ãå¾…ã¤ã¨ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‹ã®é¸æŠå¾…ã¡ã§æ­¢ã¾ã‚‹ã€‚

[[11-stop-at-choose-install-grub-boot-loader.png]]

ã“ã“ã§ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å…¥ã‚Œãªã„ã‚’é¸æŠã™ã‚‹ã®ã¯ã€ä»–ã® OS ãŒæ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ãŠã‚Šã€å…±å­˜ã•ã›ã‚‹å ´åˆã§ã‚ã‚‹ã€‚ä»Šå›ã¯æ–°è¦ã«ã¾ã£ã•ã‚‰ãªçŠ¶æ…‹ã‹ã‚‰ä½œã£ã¦ã„ã‚‹ã®ã§ã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã¯å¿…ãšã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

[[http://www.debian.org/releases/stable/amd64/apbs04.html.ja][B.4. äº‹å‰è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ (wheezy ç”¨) - B.4.11. ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«]] ã‚’å‚è€ƒã«
`d-i grub-installer/only_debian boolean true`
ã‚’è¿½è¨˜ã—ãŸã€‚

( å–å¾—ã—ãŸåˆæœŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã“ã®è¨˜è¿°ãŒãªã‹ã£ãŸã€‚ãªãœã ã‚ã†ï¼Ÿ )

ã ã‚“ã ã‚“ã‚µã‚¯ã‚µã‚¯é€²ã‚ã¦ã„ã‘ã¦ã„ã‚‹æ°—ãŒã™ã‚‹ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/af3635cc6dc799d6f247f5d75abfbb5def8bcc3a][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/af3635cc6dc799d6f247f5d75abfbb5def8bcc3a][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 12. ãƒ­ã‚°ã‚¤ãƒ³ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§æ­¢ã¾ã‚‹

"11. ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‹ã®é¸æŠå¾…ã¡ã§æ­¢ã¾ã‚‹" ãŒçµ‚ã‚ã‚‹ã¨ã€Packer ã«ã‚ˆã‚‹ä»®æƒ³ OS ã®ä½œæˆãŒã²ã¨ã¾ãšæ­£å¸¸ã«å®Œäº†ã™ã‚‹ã€‚ã‚„ã£ãŸï¼ãƒ’ãƒ¥ãƒ¼ï¼

ã•ã¦ã€æ¬¡ã« Packer ã«ã‚ˆã£ã¦ä½œæˆã—ãŸä»®æƒ³ OS ã‚’ Vagrant ã§èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚
ãã“ã§[[https://github.com/niku/my-packer-and-vagrant-example/commit/0b523797f441af224cac57d148c02894e0694747][ã“ã®ã‚ˆã†ã«]] Packer è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã® [[http://www.packer.io/docs/post-processors/vagrant.html][post-process ã« vagrant ã‚’æŒ‡å®š]]ã™ã‚‹ã€‚

ãã®çŠ¶æ…‹ã§
`$ packer build wheezy64.json -force`
ã™ã‚‹ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦æ­¢ã¾ã‚‹ã€‚

#+BEGIN_EXAMPLE
$ packer build wheezy64.json --force
virtualbox output will be in this color.

==> virtualbox: Downloading VirtualBox guest additions. Progress will be shown periodically.
==> virtualbox: Copying or downloading ISO. Progress will be reported periodically.
    virtualbox: Download progress: 0%
==> virtualbox: Starting HTTP server on port 8081
==> virtualbox: Creating virtual machine...
==> virtualbox: Creating hard drive...
==> virtualbox: Creating forwarded port mapping for SSH (host port 3213)
==> virtualbox: Starting the virtual machine...
==> virtualbox: Waiting 10s for boot...
==> virtualbox: Typing the boot command...
==> virtualbox: Waiting for SSH to become available...
#+END_EXAMPLE

ãã®éš› VirtualBox ãŒèµ·å‹•ã—ã¦ãŠã‚Šã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒå‡ºãŸã¾ã¾ã«ãªã‚‹ã€‚

[[12-stop-at-login-console.png]]

å¾…ã£ã¦ã‚‚ä½•ã‚‚ãŠããªã„ã€‚

ã“ã®å•é¡Œè§£æ±ºã®ãƒ’ãƒ³ãƒˆã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã®æœ€å¾Œã®æ–‡ç« ã«æ›¸ã„ã¦ã‚ã‚‹ã€‚
ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã§ã¯ VirturlBox ã§èµ·å‹•ã—ãŸ OS ã¸ SSH ã§æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã‚’å¾…ã£ã¦ã„ã‚‹ã€‚
ã¤ã¾ã‚Šã€VirtualBox ã§èµ·å‹•ã—ãŸ OS ã§ã¯ SSH æ¥ç¶šã‚’å—ã‘å…¥ã‚Œã‚‰ã‚Œã‚‹æº–å‚™ã‚’ã—ã¦ãŠã‹ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

SSH æ¥ç¶šã‚’å—ã‘å…¥ã‚Œã‚‹ã«ã¯ã€ssh ã®ã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½ã‚’å‹•ã‹ã—ã¦ãŠãã€‚Debian ã§ã¯ openssh-server ã¨ã„ã†ã‚‚ã®ãŒãã‚Œã«å¯¾å¿œã™ã‚‹ã®ã§

`#d-i pkgsel/include string openssh-server build-essential`
ã‚’
`d-i pkgsel/include string openssh-server`
ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã€OS ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã« openssh-server ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚ˆã†å¤‰æ›´ã™ã‚‹ã€‚

ã“ã“ã¾ã§ã‚„ã£ã¦ã€å†åº¦
`$ packer build wheezy64.json -force`
ã—ã¦ã‚‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã¯åŒã˜ã¨ã“ã‚ã§æ­¢ã¾ã‚‹ã€‚

å®Ÿã¯ SSH ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã«ã¯
1. ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã„å´ ssh ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ©Ÿèƒ½
2. ãƒ­ã‚°ã‚¤ãƒ³å—ã‘å…¥ã‚Œå´ ssh ã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½
3. ãƒ­ã‚°ã‚¤ãƒ³å—ã‘å…¥ã‚Œå´ãƒ¦ãƒ¼ã‚¶ãƒ¼å
4. ãƒ­ã‚°ã‚¤ãƒ³å—ã‘å…¥ã‚Œå´ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ or å…¬é–‹éµ
ãŒå¿…è¦ãªã®ã ã€‚

ä»Šã®çŠ¶æ…‹ã‚’æ•´ç†ã™ã‚‹ã¨ 1 ã¯ vagrant ã«çµ„è¾¼ã¾ã‚Œã¦ã„ã‚‹ã€‚
2 ã¯å…ˆç¨‹ç”¨æ„ã—ãŸ (openssh-server) ã€‚
3 ã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã„ã¦ã‚ã‚‹ [[https://github.com/niku/my-packer-and-vagrant-example/blob/cb007d5ae2518d29371a95c7bbb71c2f835a2c40/wheezy64.json#L7][ssh_username]] ã‚’åˆ©ç”¨ã™ã‚‹ã€‚
ã—ã‹ã— 4 ã«ã¤ã„ã¦ã¯ä½•ã‚‚ç”¨æ„ã—ã¦ã„ãªã„ã€‚
ãã®ãŸã‚ã« SSH ãƒ­ã‚°ã‚¤ãƒ³ãŒã§ããªã„çŠ¶æ…‹ã«ãªã£ã¦ã„ã‚‹ã€‚

ãã“ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’
`"ssh_password": "vagrant",`
ã®ã‚ˆã†ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã—ã¦ã‚„ã‚‹ã€‚

ä»Šã¾ã§ã«ãã‚‰ã¹ã¦ã€ã„ãã¤ã‹ã®å¤‰æ›´ã‚’ã—ãªã„ã¨ç›´é¢ã—ã¦ã„ã‚‹å•é¡ŒãŒè§£æ±ºã—ãªã‹ã£ãŸã®ã§ã€ã‚„ã‚„é•·ããªã£ã¦ã—ã¾ã£ãŸã€‚
è½ã¡ã¤ã„ã¦èª­ã¿ãªãŠã™ã¨ã€3 ç®‡æ‰€ã—ã‹å¤‰æ›´ã—ã¦ã„ãªã„ã®ã§ã€ã¤ã¾ã£ã¦ã‚‚ä½•åº¦ã‹è©¦ã—ã¦ã¿ã¦ã»ã—ã„ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/8681df8359226525572cef78f4a226e71c24f380][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/8681df8359226525572cef78f4a226e71c24f380][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

ã¡ãªã¿ã«ã“ã“ã¾ã§ã‚„ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã« packer_virtualbox_virtualbox.box ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚ã„ã‡ãƒ¼ã„ã€‚

```
$ packer build wheezy64.json --force
virtualbox output will be in this color.

==> virtualbox: Downloading VirtualBox guest additions. Progress will be shown periodically.
==> virtualbox: Copying or downloading ISO. Progress will be reported periodically.
==> virtualbox: Starting HTTP server on port 8081
==> virtualbox: Creating virtual machine...
==> virtualbox: Creating hard drive...
==> virtualbox: Creating forwarded port mapping for SSH (host port 3213)
==> virtualbox: Starting the virtual machine...
==> virtualbox: Waiting 10s for boot...
==> virtualbox: Typing the boot command...
==> virtualbox: Waiting for SSH to become available...
==> virtualbox: Connected to SSH!
==> virtualbox: Uploading VirtualBox version info (4.2.16)
==> virtualbox: Uploading VirtualBox guest additions ISO...
==> virtualbox: Halting the virtual machine...
==> virtualbox: Preparing to export machine...
    virtualbox: Deleting forwarded port mapping for SSH (host port 3213)
==> virtualbox: Exporting virtual machine...
==> virtualbox: Unregistering and deleting virtual machine...
==> virtualbox: Running post-processor: vagrant
==> virtualbox (vagrant): Creating Vagrant box for 'virtualbox' provider
    virtualbox (vagrant): Copying: output-virtualbox\packer-disk1.vmdk
    virtualbox (vagrant): Copying: output-virtualbox\packer.ovf
    virtualbox (vagrant): Renaming the OVF to box.ovf...
    virtualbox (vagrant): Compressing box...
Build 'virtualbox' finished.

==> Builds finished. The artifacts of successful builds are:
--> virtualbox: 'virtualbox' provider box: packer_virtualbox_virtualbox.box
```

## 13. vagrant up ã«å¤±æ•—ã™ã‚‹

ã•ã¦ vagrant box ãŒç”Ÿæˆã•ã‚ŒãŸã®ã§èµ·å‹•ã—ã¦ã¿ã‚ˆã†ã€‚

Vagrant ã¯
`vagrant up`
ã™ã‚‹ã¨èµ·å‹•ã™ã‚‹ã€‚

```
$ vagrant up
A Vagrant environment is required to run this command. Run `vagrant init`
to set one up in this directory, or change to a directory with a
Vagrantfile and try again.
```

ãŠã‚„â€¦â€¦

å®Ÿã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸­ã«ã‚‚ã‚ã‚‹ã‚ˆã†ã« Vagrantfile ã¨ã„ã†ã‚‚ã®ã‚’ç”¨æ„ã™ã‚‹ã‹ã€
vagrant init ã¨å®Ÿè¡Œã—ã¦åˆæœŸè¨­å®šã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

ãã“ã§ã€è¨€ã‚ã‚ŒãŸé€šã‚Šã«
`vagrant init`
ã‚’è¡Œãªã†ã¨ Vagrantfile ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/33b0b42f4018cc49594a5522a8f54f7ec79af4cc][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/33b0b42f4018cc49594a5522a8f54f7ec79af4cc][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 14. vagrant up ã«å¤±æ•—ã™ã‚‹(2)

Vagrantfile ã‚’ç”Ÿæˆã—ãŸã®ã§å†åº¦ vagrant up ã™ã‚‹ã€‚

```
$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
There are errors in the configuration of this machine. Please fix
the following errors and try again:

vm:
* The box 'base' could not be found.
```

ä»Šåº¦ã¯ã€Œ'base' ã¨ã„ã†åå‰ã® box ãŒè¦‹ã¤ã‘ã‚‰ã‚Œãªã„ã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

vagrant ã¯ box ã‚’åˆ©ç”¨ã™ã‚‹ã€‚ãã®éš›ã€ã©ã® box ã‚’åˆ©ç”¨ã™ã‚‹ã‹ã¯ Vagrantfile ã®ä¸­ã«æ›¸ã„ã¦ã‚ã‚‹ã€‚

ä»Šã¯
`config.vm.box = "base"`
ã¨ãªã£ã¦ã„ã‚‹ã€‚

ãã“ã§ vagrant ã¯ base ã¨ã„ã† box ã‚’æ¢ã™ãŒã€è¦‹ã¤ã‘ã‚‰ã‚Œãªã„ã€‚
ãªã®ã§ã€Œ'base' ã¨ã„ã†åå‰ã® box ãŒè¦‹ã¤ã‘ã‚‰ã‚Œãªã„ã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ã«ã¯ vagrant ã«å¯¾ã—ã¦ã€Œbase ã¨ã„ã†åå‰ã§ã“ã® box ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã—ã¾ã™ã‚ˆãƒ¼ã€ã¨æ•™ãˆã¦ã‚„ã‚Œã°ã„ã„ã€‚

ãã®ã‚³ãƒãƒ³ãƒ‰ã¯
`vagrant box add [boxå] [boxãƒ•ã‚¡ã‚¤ãƒ«å]`
ã¨ãªã‚‹ã€‚

å®Ÿè¡Œã—ã¦ã¿ã‚‹

```
$ vagrant box add base packer_virtualbox_virtualbox.box
Downloading or copying the box...
Extracting box...
Successfully added box 'base' with provider 'virtualbox'!
```

ã†ã¾ãã„ã£ãŸã‚ˆã†ã ã€‚

ä»Šå›ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã¯ä½•ã‚‚æ‰‹ã‚’åŠ ãˆã¦ã„ãªã„ã€‚

## 15. vagrant ã§èµ·å‹•ã—ãŸä»®æƒ³ç’°å¢ƒã« SSH ã§æ¥ç¶šã§ããªãã¦å¤±æ•—ã™ã‚‹

vagrant up ã™ã‚‹ã¨ã€virtural box ãŒ GUI èµ·å‹•ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚ãŒã€ãã®å¾Œä½•ã‚‚ãŠããªã„ã€‚

æ•°åˆ†å¾…ã£ã¦ã„ã‚‹ã¨ GUI ã‚‚çµ‚äº†ã—ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚‚ã‚¨ãƒ©ãƒ¼ã§çµ‚ã‚ã‚‹ã€‚

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹

```
$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
[default] Importing base box 'base'...
[default] Matching MAC address for NAT networking...
[default] Setting the name of the VM...
[default] Clearing any previously set forwarded ports...
[default] Fixed port collision for 22 => 2222. Now on port 2200.
[default] Creating shared folders metadata...
[default] Clearing any previously set network interfaces...
[default] Preparing network interfaces based on configuration...
[default] Forwarding ports...
[default] -- 22 => 2200 (adapter 1)
[default] Booting VM...
[default] Waiting for VM to boot. This can take a few minutes.
[default] Failed to connect to VM!
Failed to connect to VM via SSH. Please verify the VM successfully booted
by looking at the VirtualBox GUI.
```

vagrant ã‚’èµ·å‹•ã—ãŸç’°å¢ƒ ( ä»¥ä¸‹ã€Œãƒ›ã‚¹ãƒˆç’°å¢ƒã€ã¨å‘¼ã¶ ) ã¨ã€vagrant ã§èµ·å‹•ã•ã‚ŒãŸä»®æƒ³ç’°å¢ƒ ( ä»¥ä¸‹ã€ŒVMç’°å¢ƒã€ã¨å‘¼ã¶ ) ã®é–“ã¯ SSH ã§æ¥ç¶šã™ã‚‹ã€‚

`Failed to connect to VM via SSH. Please verify the VM successfully booted`
ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã‚‚ã‚ã‹ã‚‹ã¨ãŠã‚Šã€ã“ã® SSH æ¥ç¶šãŒã†ã¾ãã§ãã¦ã„ãªã„ã€‚

SSH æ¥ç¶šãŒã†ã¾ãã§ãã¦ã„ãªã„åŸå› ã¯å¤§ããã‚ã‘ã‚‹ã¨ä»¥ä¸‹ã® 2 ã¤ã«ãªã‚‹ã€‚

1. ä»®æƒ³ç’°å¢ƒãŒ SSH æ¥ç¶šã‚’å—ã‘ã¤ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ãªã„
2. vagrant ãŒä»®æƒ³ç’°å¢ƒã«å…¥ã‚‹ãŸã‚ã®éµç©´ ( å…¬é–‹éµ ) ã‚’ä»®æƒ³ç’°å¢ƒã«ç”¨æ„ã—ã¦ã„ãªã„

ãã“ã§ 2 ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (vagrant.sh) ã‚’è¿½åŠ ã—ã€vagrant ãŒä»®æƒ³ç’°å¢ƒã«å…¥ã‚‹ãŸã‚ã®éµç©´ ( å…¬é–‹éµ ) ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã—ãŸã€‚
( 1 ã¯å¾Œç¨‹è§£æ±ºã•ã›ã‚‹ )
```
# Install vagrant keys
mkdir -pm 700 /home/vagrant/.ssh
curl -Lo /home/vagrant/.ssh/authorized_keys \
  'https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub'
chmod 0600 /home/vagrant/.ssh/authorized_keys
chown -R vagrant:vagrant /home/vagrant/.ssh
```

ãã—ã¦ã€ãã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ packer ãŒä»®æƒ³ç’°å¢ƒæ§‹ç¯‰æ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (wheezy64.json) ã«è¿½è¨˜ã—ãŸã€‚
```
"provisioners": [{
  "type": "shell",
  "scripts": [
    "vagrant.sh"
  ]
}],
```
ã“ã“ã‚‰ã¸ã‚“ã‚„ã‚„ã“ã—ã„ãŒã€ã¤ã„ã¦ã“ã‚Œã¦ã„ã‚‹ã ã‚ã†ã‹ã€‚

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£ã—ãå‹•ä½œã™ã‚Œã°ã€SSH æ¥ç¶šã®å•é¡Œã¯è§£æ¶ˆã™ã‚‹ã®ã ãŒã€ç¾çŠ¶ã ã¨ã†ã¾ãå‹•ä½œã—ãªã„ã€‚
ä»¥ä¸‹ 16 - 18 ã®æ‰‹é †ã§è§£æ¶ˆã—ã¦ã„ã“ã†ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/a59d6dc27a09866623ec320b42befc0662a81418][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/compare/33b0b42f4018cc49594a5522a8f54f7ec79af4cc...a59d6dc27a09866623ec320b42befc0662a81418][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 16. curl ã‚³ãƒãƒ³ãƒ‰ãŒãªãã¦å¤±æ•—ã™ã‚‹

å…ˆç¨‹ã¾ã§ã¯ vagrant ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ãŸãŒã€å†åº¦ Packer ã®ãƒ“ãƒ«ãƒ‰ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ã‚†ãã€‚

```
$ ../packer/packer.exe build --force wheezy64.json
virtualbox output will be in this color.

==> virtualbox: Downloading VirtualBox guest additions. Progress will be shown periodically.
==> virtualbox: Copying or downloading ISO. Progress will be reported periodically.
==> virtualbox: Starting HTTP server on port 8081
==> virtualbox: Creating virtual machine...
==> virtualbox: Creating hard drive...
==> virtualbox: Creating forwarded port mapping for SSH (host port 3213)
==> virtualbox: Starting the virtual machine...
==> virtualbox: Waiting 10s for boot...
==> virtualbox: Typing the boot command...
==> virtualbox: Waiting for SSH to become available...
==> virtualbox: Connected to SSH!
==> virtualbox: Uploading VirtualBox version info (4.2.16)
==> virtualbox: Uploading VirtualBox guest additions ISO...
==> virtualbox: Provisioning with shell script: vagrant.sh
    virtualbox: /tmp/script.sh: line 3: curl: command not found
    virtualbox: chmod: cannot access `/home/vagrant/.ssh/authorized_keys': No such file or directory
==> virtualbox: Halting the virtual machine...
==> virtualbox: Preparing to export machine...
    virtualbox: Deleting forwarded port mapping for SSH (host port 3213)
==> virtualbox: Exporting virtual machine...
==> virtualbox: Unregistering and deleting virtual machine...
==> virtualbox: Running post-processor: vagrant
==> virtualbox (vagrant): Creating Vagrant box for 'virtualbox' provider
    virtualbox (vagrant): Copying: output-virtualbox\packer-disk1.vmdk
    virtualbox (vagrant): Copying: output-virtualbox\packer.ovf
    virtualbox (vagrant): Renaming the OVF to box.ovf...
    virtualbox (vagrant): Compressing box...
Build 'virtualbox' finished.

==> Builds finished. The artifacts of successful builds are:
--> virtualbox: 'virtualbox' provider box: packer_virtualbox_virtualbox.box
```

`virtualbox: /tmp/script.sh: line 3: curl: command not found`
ã¨ãªã£ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹ã ã‚ã†ã‹ã€‚ã€Œcurl ã‚³ãƒãƒ³ãƒ‰ãŒãªã„ã€ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã€‚

ç¢ºã‹ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãªã„ã®ã§ã€ãªã„ã€‚ãã“ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

curl ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (apt) çµŒç”±ã§è¡Œã†ã®ãŒç°¡å˜ã ã€‚
ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸çµŒç”±ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ä»¥å‰ 3 - 11 ã®æ‰‹é †ã§ã‚‚åˆ©ç”¨ã—ã¦ã„ãŸ preseed.cfg çµŒç”±ã§è¡Œãªãˆã‚‹ã€‚
ä»Šå›ã¯ã“ã‚Œã‚’ä½¿ã†ã€‚

preseed.cfg ã®
`d-i pkgsel/include string openssh-server`
ã‚’
`d-i pkgsel/include string openssh-server curl`
ã¨ã™ã‚‹ã“ã¨ã§ã€curl ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã€curl ã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/66c401233a18c6aee0583610dc582f2db35cf475][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/66c401233a18c6aee0583610dc582f2db35cf475][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 17. provisioning ã§è¡Œãªã£ãŸä»®æƒ³ç’°å¢ƒã®å¤‰æ›´ãŒä¿å­˜ã•ã‚Œãªã„

ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€ç€ã€…ã¨é€²ã‚€ã®ã§ã€Œã†ã¾ãã„ã£ãŸã‹ãªã€ã¨æ€ã£ã¦ã—ã¾ã†ã€‚
ã—ã‹ã—å¾Œè¿°ã™ã‚‹ã‚ˆã†ã«ã€å®Ÿã¯ã†ã¾ãã„ã£ã¦ãªã„ã€‚

```
$ packer build wheezy64.json --force
virtualbox output will be in this color.

==> virtualbox: Downloading VirtualBox guest additions. Progress will be shown periodically.
==> virtualbox: Copying or downloading ISO. Progress will be reported periodically.
==> virtualbox: Starting HTTP server on port 8081
==> virtualbox: Creating virtual machine...
==> virtualbox: Creating hard drive...
==> virtualbox: Creating forwarded port mapping for SSH (host port 3213)
==> virtualbox: Starting the virtual machine...
==> virtualbox: Waiting 10s for boot...
==> virtualbox: Typing the boot command...
==> virtualbox: Waiting for SSH to become available...
==> virtualbox: Connected to SSH!
==> virtualbox: Uploading VirtualBox version info (4.2.16)
==> virtualbox: Uploading VirtualBox guest additions ISO...
==> virtualbox: Provisioning with shell script: vagrant.sh
    virtualbox: % Total    % Received % Xferd  Average Speed   Time    Time      Time  Current
    virtualbox: Dload  Upload   Total   Spent    Left  Speed
    virtualbox: 0     0    0     0    0     0      0      0 --:--:-- --:--:-- -- 100   409  100   409    0     0    607      0 --:--:-- --:--:-- --:--:--   791
==> virtualbox: Halting the virtual machine...
==> virtualbox: Preparing to export machine...
    virtualbox: Deleting forwarded port mapping for SSH (host port 3213)
==> virtualbox: Exporting virtual machine...
==> virtualbox: Unregistering and deleting virtual machine...
==> virtualbox: Running post-processor: vagrant
==> virtualbox (vagrant): Creating Vagrant box for 'virtualbox' provider
    virtualbox (vagrant): Copying: output-virtualbox\packer-disk1.vmdk
    virtualbox (vagrant): Copying: output-virtualbox\packer.ovf
    virtualbox (vagrant): Renaming the OVF to box.ovf...
    virtualbox (vagrant): Compressing box...
Build 'virtualbox' finished.

==> Builds finished. The artifacts of successful builds are:
--> virtualbox: 'virtualbox' provider box: packer_virtualbox_virtualbox.box

$ vagrant box add base packer_virtualbox_virtualbox.box
Downloading or copying the box...
Extracting box...
Successfully added box 'base' with provider 'virtualbox'!

$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
[default] Importing base box 'base'...
[default] Matching MAC address for NAT networking...
[default] Setting the name of the VM...
[default] Clearing any previously set forwarded ports...
[default] Fixed port collision for 22 => 2222. Now on port 2200.
[default] Creating shared folders metadata...
[default] Clearing any previously set network interfaces...
[default] Preparing network interfaces based on configuration...
[default] Forwarding ports...
[default] -- 22 => 2200 (adapter 1)
[default] Booting VM...
[default] Waiting for VM to boot. This can take a few minutes.
[default] Failed to connect to VM!
Failed to connect to VM via SSH. Please verify the VM successfully booted
by looking at the VirtualBox GUI.

$ ssh vagrant@localhost -p 2200
The authenticity of host '[localhost]:2200 ([127.0.0.1]:2200)' can't be established.
RSA key fingerprint is 07:c3:14:6c:e2:e9:84:0b:5e:69:57:a5:e0:0b:6f:9b.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '[localhost]:2200' (RSA) to the list of known hosts.
vagrant@localhost's password:
Linux packer-virtualbox 3.2.0-4-amd64 #1 SMP Debian 3.2.46-1 x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
vagrant@packer-virtualbox:~$ ls -ltra
total 20
-rw-r--r-- 1 vagrant vagrant  675 Aug 19 02:49 .profile
-rw-r--r-- 1 vagrant vagrant  220 Aug 19 02:49 .bash_logout
drwxr-xr-x 3 root    root    4096 Aug 19 02:49 ..
drwxr-xr-x 2 vagrant vagrant 4096 Aug 19 02:49 .
-rw-r--r-- 1 vagrant vagrant 3392 Aug 19 02:49 .bashrc
```

ã‚ã‹ã‚‹ã ã‚ã†ã‹ã€‚
provisioning ä¸­ã« curl ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã¯ãšã® .ssh/authorized_keys ãŒã€
æ”¹ã‚ã¦ä»®æƒ³ç’°å¢ƒã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ã‚‹ã¨å­˜åœ¨ã—ã¦ã„ãªã„ã€‚

ã“ã“ã¯æœ¬å½“ã«åŸå› ã‚’æ´ã‚€ã®ã«è‹¦åŠ´ã—ãŸã€‚çš†ã«ã¯ã“ã‚“ãªæ€ã„ã‚’ã—ã¦æ¬²ã—ããªã„ã®ã§å¤§ãã 3 å›æ›¸ã„ã¦ãŠãã€‚


 *provisioningçµ‚äº†æ™‚ã®shutdownã‚’gracefulã«è¡Œã‚ãªã„ã¨ä»®æƒ³ç’°å¢ƒã«ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã‚‰ãªã„*

 *provisioningçµ‚äº†æ™‚ã®shutdownã‚’gracefulã«è¡Œã‚ãªã„ã¨ä»®æƒ³ç’°å¢ƒã«ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã‚‰ãªã„*

 *provisioningçµ‚äº†æ™‚ã®shutdownã‚’gracefulã«è¡Œã‚ãªã„ã¨ä»®æƒ³ç’°å¢ƒã«ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã‚‰ãªã„*

æ™®æ®µçš†ã•ã‚“ãŒ PC ã‚’ä½¿ã„çµ‚ã£ã¦é›»æºã‚’åˆ‡ã‚‹æ™‚ã«ã©ã†ã™ã‚‹ã ã‚ã†ã‹ï¼Ÿ
å„ OS ã«ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚Šã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ shutdown ã‚’å®Ÿè¡Œã™ã‚‹ã ã‚ã†ã€‚
ãã†ã™ã‚‹ã¨ã€OS ã¯é›»æºã‚’åˆ‡ã‚‹æº–å‚™ã‚’ã—ã¦ã€å¤‰æ›´é€”ä¸­ã®ã‚‚ã®ã¯ãƒ‡ã‚£ã‚¹ã‚¯ã«æ›¸ãè¾¼ã‚“ã§æ°¸ç¶šåŒ–ã—ãŸå¾Œã€è‡ªã‚‰é›»æºã‚’åˆ‡ã‚‹ã€‚

Packer ã‚‚ provisioning çµ‚äº†æ™‚ã«ä¸€åº¦ä»®æƒ³ç’°å¢ƒã®é›»æºã‚’åˆ‡ã‚‹ã€‚ãã®æ™‚ã«ã©ã†ã‚„ã£ã¦é›»æºã‚’åˆ‡ã‚‹ã‹ã€‚
Packer ã¯ä½•ã‚‚è¨­å®šã•ã‚Œã¦ã„ãªã„ã¨ã€Œãƒã‚·ãƒ³ã®é›»æºã‚’åˆ‡ã‚‹ã€ç›¸å½“ã®ã“ã¨ã‚’ä»®æƒ³ç’°å¢ƒã«å¯¾ã—ã¦è¡Œã†ã€‚
ã¤ã¾ã‚Šã€OS ã¯å¤‰æ›´é€”ä¸­ã®ã‚‚ã®ã‚’ãƒ‡ã‚£ã‚¹ã‚¯ã«æ›¸ãè¾¼ã‚“ã§æ°¸ç¶šåŒ–ã™ã‚‹æ™‚é–“ãŒãªã„ã€‚

ãã®ãŸã‚ã€å†åº¦ä»®æƒ³ç’°å¢ƒã‚’ç«‹ã¡ä¸Šã’ãŸã¨ãã«ã€å¤‰æ›´ãŒä¿å­˜ã•ã‚Œã¦ã„ãªã„ã®ã ã€‚

è©³ã—ãã¯ [[http://www.packer.io/docs/builders/virtualbox.html][VirtualBox Builder]] ã® shutdown_command ã‚’å‚ç…§ã—ã¦ã‚‚ã‚‰ã„ãŸã„ã€‚
`By default this is an empty string, which tells Packer to just forcefully shut down the machine.`
ã€Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç©ºæ–‡å­—ã«ãªã£ã¦ã„ã‚‹ã€ã¤ã¾ã‚Š Packer ã¯å˜ã«ã‚€ã‚Šã‚„ã‚Šãƒã‚·ãƒ³ã‚’åˆ‡ã‚‹ã€ã¨æ›¸ã„ã¦ã‚ã‚‹ã€‚

ãã†ã—ãªã„ãŸã‚ã«ã¯ã€ãã®å‰ã®æ–‡ã«å¾“ãˆã°ã„ã„ã€‚
`The command to use to gracefully shut down the machine once all the provisioning is done.`
ã€Œå…¨ã¦ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãŒçµ‚ã‚ã£ãŸã¨ãã«ã¡ã‚ƒã‚“ã¨ (graceful ã« ) ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã€ã‚’è¨­å®šã™ã‚‹ã¨æ›¸ã„ã¦ã‚ã‚‹ã€‚

ã¤ã¾ã‚Šã€ã“ã“ã«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã‚³ãƒãƒ³ãƒ‰ã‚’æ›¸ã‘ã°ã€ç„¡ç†çŸ¢ç† â€ ã§ã¯ãªã„ â€ æ–¹æ³•ã§ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã—ã¦ãã‚Œã‚‹ã€‚

ãã“ã§ wheezy64.json ã¸
`"shutdown_command": "sudo shutdown -h now"`
ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/3db48d01158af5c96e43be31088867eb84c90773][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/3db48d01158af5c96e43be31088867eb84c90773][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 18 sudo ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã« password ã®å…¥åŠ›ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ç”»é¢ã§æ­¢ã¾ã‚‹

å†åº¦ packer build ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹

```
$ packer build --force wheezy64.json
virtualbox output will be in this color.

==> virtualbox: Downloading VirtualBox guest additions. Progress will be shown periodically.
==> virtualbox: Copying or downloading ISO. Progress will be reported periodically.
==> virtualbox: Starting HTTP server on port 8081
==> virtualbox: Creating virtual machine...
==> virtualbox: Creating hard drive...
==> virtualbox: Creating forwarded port mapping for SSH (host port 3213)
==> virtualbox: Starting the virtual machine...
==> virtualbox: Waiting 10s for boot...
==> virtualbox: Typing the boot command...
==> virtualbox: Waiting for SSH to become available...
==> virtualbox: Connected to SSH!
==> virtualbox: Uploading VirtualBox version info (4.2.16)
==> virtualbox: Uploading VirtualBox guest additions ISO...
==> virtualbox: Provisioning with shell script: vagrant.sh
    virtualbox: % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
    virtualbox: Dload  Upload   Total   Spent    Left  Speed
100   409  100   409    0     0    651      0 --:--:-- --:--:-- --:--:--   853--:--:--     0
==> virtualbox: Gracefully halting virtual machine...
    virtualbox:
    virtualbox: We trust you have received the usual lecture from the local System
    virtualbox: Administrator. It usually boils down to these three things:
    virtualbox:
    virtualbox: #1) Respect the privacy of others.
    virtualbox: #2) Think before you type.
    virtualbox: #3) With great power comes great responsibility.
    virtualbox:
```

ã™ã‚‹ã¨ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã¦ãã¦æ­¢ã¾ã£ã¦ã—ã¾ã†ã€‚

ã“ã‚Œã¯ sudo ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«å‡ºã¦ãã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã€
ã“ã“ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ä»Šå›ã ã¨ vagrant ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€sudo ã®å¾Œã«ã¤ãªã’ãŸã‚³ãƒãƒ³ãƒ‰ãŒç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

ç®¡ç†è€…æ¨©é™ã¨ã¯ä½•ã‹ã€‚
ãã‚‚ãã‚‚ linux ã¯è¤‡æ•°ã®ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ä½œæ¥­ã™ã‚‹ã“ã¨ã‚’å‰æã«ã—ã¦ã„ã‚‹ã€‚
ãã®å‰æã«ç«‹ã£ã¦ã¿ã‚‹ã¨ã€é›»æºã‚’åˆ‡ã£ãŸã‚Šã€å†èµ·å‹•ã—ãŸã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹æˆã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ãŒã¨ã¦ã‚‚å¤§ãã„ã€‚
( è‡ªåˆ†ãŒä½œæ¥­ä¸­ãªã®ã«ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é›»æºã‚’åˆ‡ã‚‰ã‚ŒãŸã‚‰â€¦â€¦ãŠãã‚ã—ã„ >< )

ãã“ã§ã€ãã†ã„ã£ãŸã“ã¨ã‚’ã™ã‚‹å ´åˆã«ã¯é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªãã€ç®¡ç†è€…æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã„ã†ç«‹å ´ã§ä½œæ¥­ã™ã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚
sudo ã¯ã€Œsudo ä»¥é™ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ç®¡ç†è€…æ¨©é™ã¨ã—ã¦å®Ÿè¡Œã—ãŸã„ã§ã™ã‚ˆãƒ¼ã€ã¨ã„ã†å®£è¨€ã«ãªã‚‹ã€‚
ä»Šå›ã¯ã€Œã™ãã«é›»æºã‚’åˆ‡ã‚‹ =shutdown -h now= ã€ã¨ã„ã†ã“ã¨ã‚’ã€ç®¡ç†è€…æ¨©é™ã§è¡Œãªã„ãŸã„ã¨å®£è¨€ã—ã¦ã„ã‚‹ã€‚

ä»Šå›ã ã¨
`sudo shutdown -h now`
ã®å®Ÿè¡Œæ™‚ã«å‡ºã¦ã„ã‚‹ã®ã§ã€vagrant ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã§ãã‚Œã°ã€ç®¡ç†è€…æ¨©é™ã§
`shutdown -h now`
ãŒå®Ÿè¡Œã•ã‚Œã€ä»®æƒ³ç’°å¢ƒã®é›»æºãŒåˆ‡ã‚‰ã‚Œã‚‹ã€‚

è‡ªå‹•å®Ÿè¡Œä¸­ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å¾…ã¡ã§æ­¢ã¾ã£ã¦ã—ã¾ã†ã®ã¯å›°ã‚‹ã®ã§ã€æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ã«ã¯ 2 ã¤ã®æ–¹æ³•ãŒã‚ã‚‹ã€‚

1. =echo 'password' | sudo -S shutdown -h now=  ã®ã‚ˆã†ã« sudo å®Ÿè¡Œæ™‚ã« vagrant ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¸ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ see [[http://stackoverflow.com/questions/233217/pass-password-to-su-sudo-ssh][pass password to su/sudo/ssh]]
2. ãã‚‚ãã‚‚ vagrant ã® sudo å®Ÿè¡Œæ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ãªã„

ä»Šå›ã¯ vagrant ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã‚’ç„¡æ¡ä»¶ã§ä¿¡ã˜ã‚‹ã€ã¤ã¾ã‚Š vagrant ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ sudo ã—ãŸã‚‚ã®ã¯å…¨ã¦è¨±å¯ã™ã‚‹ã®ã§ 2 ã§ã™ã™ã‚ã‚‹ã€‚

Debian ã®å ´åˆ sudo ã®è¨­å®šã¯ =/etc/sudoers= ã«æ›¸ãã‹ã€ =/etc/sudoers.d/= ä»¥ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãã¨ã‚ˆã„ã€‚
ä»Šå›ã¯ sudores.d ä»¥ä¸‹ã« vagrant ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ã€ãã®ä¸­ã« vagrant ã® sudo æ¡ä»¶ã‚’è¨˜è¿°ã™ã‚‹ã‚ˆã†ã«ã—ãŸã€‚

sudores.d ä»¥ä¸‹ã«æœ‰åŠ¹ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãå ´åˆã¯
1. æ¨©é™ãŒ root ã§ã‚ã‚‹ã“ã¨
2. root æ¨©é™ã®äººã®ã¿ãŒèª­ã¿è¾¼ã‚ã‚‹ã“ã¨
ã¨ã„ã†åˆ¶ç´„ãŒã‚ã‚‹ã®ã§ã€æ³¨æ„ã™ã‚‹ã€‚ãã‚Œã«å¯¾å¿œã—ãŸã®ãŒä»¥ä¸‹ã®ã‚ˆã†ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãªã‚‹ã€‚

```
# Set up sudo
echo 'vagrant ALL=NOPASSWD:ALL' > vagrant
echo 'vagrant' | sudo -S chmod 440 vagrant
echo 'vagrant' | sudo -S chown root:root vagrant
echo 'vagrant' | sudo -S mv vagrant /etc/sudoers.d/
```

ã“ã‚Œã‚’ base.sh ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã€‚

ã¾ãŸã€ãã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã« =wheezy64.json= ã¸è¿½è¨˜ã™ã‚‹ã€‚

```
"provisioners": [{
  "type": "shell",
  "scripts": [
    "base.sh",
    "vagrant.sh"
  ]
}],
```

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/591b8e5b9ddaf878c983177a1d796dba3de7af06][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/591b8e5b9ddaf878c983177a1d796dba3de7af06][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

ã“ã“ã¾ã§ã‚„ã‚‹ã¨
`packer build --force wheezy64.json`
ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã§ã€ä»®æƒ³ç’°å¢ƒæ§‹ç¯‰ãŒã§ãã€ãã®ä»®æƒ³ç’°å¢ƒã« vagrant ãŒ SSH ã§æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

ã¤ã¾ã‚Šã€Œ15. vagrant ã§èµ·å‹•ã—ãŸä»®æƒ³ç’°å¢ƒã« SSH ã§æ¥ç¶šã§ããªãã¦å¤±æ•—ã™ã‚‹ã€ã‹ã‚‰ã®èª²é¡Œã¯ä¸€é€šã‚Šè§£æ±ºã—ã€
ã€ŒPacker ã§ä»®æƒ³ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ã€ã¨ã„ã†éƒ¨åˆ†ã¯é”æˆã§ããŸã“ã¨ã«ãªã‚‹ã€‚

ã‚¦ã‚©ã‚ªã‚©ã‚©ã‚©ã‚©ï¼

ï¼ˆå„è‡ªã²ã¨ã¨ãŠã‚Šè‡ªåˆ†ãªã‚Šã«å–œã³ã‚’è¡¨ã‚ã—ã¦ã‚‚ã‚‰ã„ãŸã„ï¼‰

â€¦â€¦ãµã…ã€‚

ã•ã¦ã€æ¬¡ã«ã€Œpacker ã§ç’°å¢ƒæ§‹ç¯‰ã—ãŸä»®æƒ³ç’°å¢ƒã§ chef-solo ã‚’å®Ÿè¡Œã™ã‚‹ã€ã¨ã„ã†ã‚¹ãƒ†ãƒƒãƒ—ã«å…¥ã‚ã†ã€‚
vagrant ã‹ã‚‰ chef-solo ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ Vagrantfile ã« [[http://docs.vagrantup.com/v2/provisioning/chef_solo.html][Chef Solo Provisioner]] ã‚’è¨˜è¿°ã™ã‚Œã°ã‚ˆã„ã€‚
ãã“ã§ Vagrantfile ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½è¨˜ã™ã‚‹ã€‚

```
config.vm.provision :chef_solo do |chef|
end
```

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/7814591e503b626b798b669cc4d12796dbbaf455][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/7814591e503b626b798b669cc4d12796dbbaf455][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 19. chef ãŒãªã„ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦æ­¢ã¾ã‚‹

å‰å›ã¾ã§ã§ packer ã®å‡¦ç†ã¯ã†ã¾ãã„ã£ãŸã‚ˆã†ãªã®ã§ã€æ¬¡ã« vagrant ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã€‚

```
$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
[default] Setting the name of the VM...
[default] Clearing any previously set forwarded ports...
[default] The cookbook path 'c:/Users/niku/my-packer-and-vagrant-example                                                                                                                                         /cookbooks' doesn't exist. Ignoring...
[default] Fixed port collision for 22 => 2222. Now on port 2200.
[default] Creating shared folders metadata...
[default] Clearing any previously set network interfaces...
[default] Preparing network interfaces based on configuration...
[default] Forwarding ports...
[default] -- 22 => 2200 (adapter 1)
[default] Booting VM...
[default] Waiting for VM to boot. This can take a few minutes.
[default] VM booted and ready for use!
[default] The guest additions on this VM do not match the installed version of
VirtualBox! In most cases this is fine, but in rare cases it can
cause things such as shared folders to not work properly. If you see
shared folder errors, please update the guest additions within the
virtual machine and reload your VM.

Guest Additions Version: 4.1.18
VirtualBox Version: 4.2
[default] Mounting shared folders...
[default] -- /vagrant
[default] Running provisioner: chef_solo...
The chef binary (either `chef-solo` or `chef-client`) was not found on
the VM and is required for chef provisioning. Please verify that chef
is installed and that the binary is available on the PATH.
```

chef_solo ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ãŸã®ã ãŒã€chef binary ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã€‚

ã‚ã£ã€ã¯ã„ã€‚ã¾ã ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸâ€¦â€¦

ã‚‚ã†ä¸€åº¦ packer ã®å‡¦ç†ã«æˆ»ã£ã¦ã€chef ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ä»®æƒ³ç’°å¢ƒæ§‹ç¯‰ã«çµ„è¾¼ã‚€ã€‚

chef ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¯å…¬å¼ã‚µã‚¤ãƒˆã® [[http://www.opscode.com/chef/install/][Install Chef]] ã‚’ã¿ã‚‹ã¨ã‚ˆã„ã€‚

ä»Šå›ã¯
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãªã®ã§ Chef Client ã‚¿ãƒ–ã‚’é¸æŠ
- Debian ãªã®ã§ [Select an Operating System] ã‹ã‚‰ Debian ã‚’é¸æŠ
- Wheezy(7) ãªã®ã§ [Select a Version] ã‹ã‚‰ 7 ã‚’é¸æŠ
- 64 ãƒ“ãƒƒãƒˆãªã®ã§ [Select an Architecture] ã‹ã‚‰ x86_64 ã‚’é¸æŠ
ã—ãŸã€‚

ãã†ã™ã‚‹ã¨ç”»é¢å³å´ã«  Quick Install Instructions ã¨ã„ã†ã®ãŒè¡¨ã‚Œã¦ã€
ç°¡å˜ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰
`curl -L https://www.opscode.com/chef/install.sh | sudo bash`
ãŒæ›¸ã„ã¦ã‚ã‚‹ã®ã§ã€ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ã€‚

chef.sh ã¨ã„ã†åå‰ã§ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¦
```
# install Omnibus Chef Client
curl -L https://www.opscode.com/chef/install.sh | sudo bash
```

packer å®Ÿè¡Œæ™‚ã«ä»®æƒ³ç’°å¢ƒå†…ã‹ã‚‰èµ·å‹•ã™ã‚‹ã‚ˆã† wheezy64.json ã«è¿½è¨˜ã™ã‚‹
```
     "type": "shell",
     "scripts": [
       "base.sh",
       "chef.sh",
       "vagrant.sh"
     ]
```

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/680035140cd6ee2d171bac1095c4b8144eb11ca6][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/680035140cd6ee2d171bac1095c4b8144eb11ca6][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

## 20. cookbook ãŒãªã„ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦æ­¢ã¾ã‚‹

ã¾ãšå‰å›ä¿®æ­£ã—ãŸå†…å®¹ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ãŸã‚ã« packer ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
`packer build --force wheezy64.json`

packer ã¯æ­£å¸¸çµ‚äº†ã™ã‚‹ã®ã§ã€æ¬¡ã« vagrant ã‚’èµ·å‹•ã™ã‚‹ã€‚
```
$ vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
[default] Importing base box 'base'...
[default] Matching MAC address for NAT networking...
[default] Setting the name of the VM...
[default] Clearing any previously set forwarded ports...
[default] The cookbook path 'c:/Users/niku/my-packer-and-vagrant-example/cookbooks' doesn't exist. Ignoring...
[default] Fixed port collision for 22 => 2222. Now on port 2200.
[default] Creating shared folders metadata...
[default] Clearing any previously set network interfaces...
[default] Preparing network interfaces based on configuration...
[default] Forwarding ports...
[default] -- 22 => 2200 (adapter 1)
[default] Booting VM...
[default] Waiting for VM to boot. This can take a few minutes.
[default] VM booted and ready for use!
[default] The guest additions on this VM do not match the installed version of
VirtualBox! In most cases this is fine, but in rare cases it can
cause things such as shared folders to not work properly. If you see
shared folder errors, please update the guest additions within the
virtual machine and reload your VM.

Guest Additions Version: 4.1.18
VirtualBox Version: 4.2
[default] Mounting shared folders...
[default] -- /vagrant
[default] Running provisioner: chef_solo...
Generating chef JSON and uploading...
[default] Warning: Chef solo run list is empty. This may not be what you want.
Running chef-solo...
stdin: is not a tty
[2013-08-19T22:03:26-04:00] INFO: Forking chef instance to converge...
[2013-08-19T22:03:26-04:00] INFO: *** Chef 11.6.0 ***
[2013-08-19T22:03:27-04:00] INFO: Run List is []
[2013-08-19T22:03:27-04:00] INFO: Run List expands to []
[2013-08-19T22:03:27-04:00] INFO: Starting Chef Run for packer-virtualbox.vagrantup.com
[2013-08-19T22:03:27-04:00] INFO: Running start handlers
[2013-08-19T22:03:27-04:00] INFO: Start handlers complete.
[2013-08-19T22:03:27-04:00] FATAL: No cookbook found in ["/tmp/vagrant-chef-1/cookbooks/cookbooks"], make sure cookbook_path is set correctly.
[2013-08-19T22:03:27-04:00] ERROR: Running exception handlers
[2013-08-19T22:03:27-04:00] ERROR: Exception handlers complete
[2013-08-19T22:03:27-04:00] FATAL: Stacktrace dumped to /var/chef/cache/chef-stacktrace.out
[2013-08-19T22:03:27-04:00] FATAL: Chef::Exceptions::ChildConvergeError: Chef run process exited unsuccessfully (exit code 1)
Chef never successfully completed! Any errors should be visible in the
output above. Please fix your recipes so that they properly complete.
```

ã”è¦§ã®é€šã‚Šã€ã†ã¾ãã„ã£ã¦ã„ãªã„ã€‚
`No cookbook found in ["/tmp/vagrant-chef-1/cookbooks/cookbooks"], make sure cookbook_path is set correctly.`
ã‚¯ãƒƒã‚¯ãƒ–ãƒƒã‚¯ãŒè¦‹å½“ã‚‰ãªã„ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã€‚

ç¢ºã‹ã«ã€ã¾ã ã‚¯ãƒƒã‚¯ãƒ–ãƒƒã‚¯ã‚’ç™»éŒ²ã—ã¦ã„ãªã„ã€‚ãã“ã§ç™»éŒ²ã™ã‚‹ã€‚

ã‚¯ãƒƒã‚¯ãƒ–ãƒƒã‚¯ã¯ä½•ã§ã‚‚ã‚ˆã„ã€‚ã“ã“ã§ã¯ä¾‹ã¨ã—ã¦ã€ä»Šå¾Œã‚‚ã‚ˆãä½¿ã†ã§ã‚ã‚ã† [[https://github.com/opscode-cookbooks/build-essential][build-essential]] ã‚’å…¥ã‚Œã¦ã¿ã‚‹ã€‚

ã¾ãšã€ã‚¯ãƒƒã‚¯ãƒ–ãƒƒã‚¯ã‚’ç½®ããƒ‘ã‚¹ãŒãªã„ã®ã§ç”¨æ„ã™ã‚‹ã€‚ã“ã‚Œã¯ 1 åº¦ã ã‘è¡Œãˆã°ã‚ˆã„ã€‚
`mkdir -p chef-recipes/cookbooks`

æ¬¡ã«ãã®ãƒ‘ã‚¹ã¸ç§»å‹•ã™ã‚‹ã€‚
`cd chef-recipes/cookbooks`

ãã—ã¦ã‚¯ãƒƒã‚¯ãƒ–ãƒƒã‚¯ã‚’ç”¨æ„ã™ã‚‹ã€‚
`git clone https://github.com/opscode-cookbooks/build-essential.git`

ä¸Šã®3ã¤ã‚’è¡Œãªã„ã€å†åº¦ `vagrant up` ã™ã‚‹ã¨ã€ç„¡äº‹ã« vagrant ãŒèµ·å‹•ã™ã‚‹ã€‚
ã™ãªã‚ã¡ã€Œpacker ã‹ã‚‰ vagrant ã® chef-solo provision å¯¾å¿œã®ä»®æƒ³ç’°å¢ƒã‚’ã€ã‚³ãƒãƒ³ãƒ‰ä¸€ã¤ã§ä½œæˆã§ãã€ãŸã“ã¨ã«ãªã‚‹ã€‚

- [[https://github.com/niku/my-packer-and-vagrant-example/tree/5926522f675701be9e61e2e9a3104339f25826db][ã“ã“ã¾ã§ã®çŠ¶æ…‹]]
- [[https://github.com/niku/my-packer-and-vagrant-example/commit/5926522f675701be9e61e2e9a3104339f25826db][å‰å›ã‹ã‚‰ã®å·®åˆ†]]

ãµãƒ¼ã€‚ã“ã®è¨˜äº‹ã¯ã“ã‚Œã§ãŠã—ã¾ã„ã€‚
1 ãƒ¶æœˆåŠãã‚‰ã„ã‹ã‘ã¦ãƒãƒãƒãƒæ›¸ã„ã¦ã€ã¡ã‚‡ã†ã© 1000 è¡Œã«ã‚ãŸã‚‹è¨˜äº‹ã«ãªã£ãŸã€‚èª­ã‚“ã§ãã‚ŒãŸäººã‚‚ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚
