---
title: "APIè¨˜è¿°è¨€èªcadlã‚’è©¦ã—ãŸ"
emoji: "ğŸ’¨"
type: "tech"
topics:
  - "openapi"
  - "cadl"
published: true
published_at: "2022-04-06 22:50"
---

ã‚³ãƒ¼ãƒ‰ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ã€API ã®ä»•æ§˜ã‚’è¨˜è¿°ã™ã‚‹ç›®çš„ã«ç‰¹åŒ–ã—ãŸè¨€èª [cadl](https://github.com/microsoft/cadl) ã‚’è©¦ã—ãŸã€‚

ä»Šã®ã¨ã“ã‚ cadl ã‚’å…ƒã« OpenAPI ã®ç”ŸæˆãŒã§ãã€README ã«ã‚ˆã‚‹ã¨ GraphQL, gRPC ãªã©ã®ç”Ÿæˆã‚‚è¦–é‡ã«å…¥ã£ã¦ã„ã‚‹ã‚ˆã†ã ã€‚OpenAPI ã‚’ç”Ÿæˆã™ã‚‹ãã‚‰ã„ãªã‚‰ã€ç›´æ¥ OpenAPI ã‚’ä½¿ãˆã°ã‚ˆã„ã¨ã„ã†ã®ã¯ã€ä¸€ç†ã‚ã‚‹ã€‚é•ã„ã¯ãªã‚“ã ã‚ã†ã‹ã€‚

OpenAPI ã®åˆ©ç”¨ä¾‹ã¨ã—ã¦ã‚ˆãåˆ©ç”¨ã•ã‚Œã‚‹ [PetStore ã¨ã„ã†ã‚¹ã‚­ãƒ¼ãƒå®šç¾©](https://github.com/OAI/OpenAPI-Specification/blob/main/examples/v3.0/petstore.json)ã¨ä¼¼ãŸã‚³ãƒ¼ãƒ‰ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã« cadl ã§æ›¸ã„ãŸ API ä»•æ§˜ã ã€‚

ãƒªãƒ³ã‚¯å…ˆã® json ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã¨è¦‹æ¯”ã¹ã‚‹ã¨ã€äººé–“ãŒã‚ˆã‚Šå®¹æ˜“ã«èª­ã¿æ›¸ãã§ããã†ãªã®ã¯ cadl ã§ã‚ã‚‹ã‚ˆã†ã«æ€ãˆãªã„ã ã‚ã†ã‹ã€‚

```typescript
import "@cadl-lang/rest";
import "@cadl-lang/openapi";
import "@cadl-lang/openapi3";

@serviceVersion("1.0.0")
@serviceTitle("Swagger Petstore")
@serviceHost("petstore.swagger.io/v1")
namespace PetStore;

using Cadl.Http;

model Pet {
  id: int64;
  name: string;
  tag?: string;
}

@defaultResponse
@doc("unexpected error")
model Error {
  code: int32;
  message: string;
}

@route("/pets")
namespace Pets {
  @get
  @operationId("listPets")
  @tag("pets")
  op listPets(
    @query @doc("How many items to return at one time (max 100)") limit?: int32
  ): {
    @statusCode statusCode: 200;
    @header @doc("A link to the next page of responses") "x-next": string;
    @body body: Pet[];
  } | Error;

  @post
  @operationId("createPets")
  @tag("pets")
  op createPets(): CreatedResponse | Error;

  @get
  @operationId("showPetById")
  @tag("pets")
  op showPetById(
    @path @doc("The id of the pet to retrieve") petId: string
  ): OkResponse<Pet> | Error;
}
```

:::details OpenAPI ã®å®šç¾©ï¼ˆ petstore.json ï¼‰ã€cadl ã‹ã‚‰ç”Ÿæˆã—ãŸå®šç¾©ï¼ˆ openapi.json ï¼‰ã‚’å…ƒã«ã€å·®åˆ†ãŒå‡ºã™ããªã„ã‚ˆã†ã«æ„å‘³ã‚’ã‹ãˆãªã„å¤‰æ›´ã‚’åŠ ãˆãŸã‚‚ã®ã® diff

```diff
--- petstore.json	2022-04-06 21:39:43.000000000 +0900
+++ openapi.json	2022-04-06 21:48:03.000000000 +0900
@@ -1,21 +1,22 @@
 {
   "openapi": "3.0.0",
   "info": {
-    "version": "1.0.0",
     "title": "Swagger Petstore",
-    "license": {
-      "name": "MIT"
-    }
+    "version": "1.0.0"
   },
   "servers": [
     {
-      "url": "http://petstore.swagger.io/v1"
+      "url": "https://petstore.swagger.io/v1"
+    }
+  ],
+  "tags": [
+    {
+      "name": "pets"
     }
   ],
   "paths": {
     "/pets": {
       "get": {
-        "summary": "List all pets",
         "operationId": "listPets",
         "tags": [
           "pets"
@@ -34,19 +35,24 @@
         ],
         "responses": {
           "200": {
-            "description": "A paged array of pets",
+            "description": "Ok",
             "headers": {
               "x-next": {
                 "description": "A link to the next page of responses",
                 "schema": {
-                  "type": "string"
+                  "type": "string",
+                  "description": "A link to the next page of responses"
                 }
               }
             },
             "content": {
               "application/json": {
                 "schema": {
-                  "$ref": "#/components/schemas/Pets"
+                  "type": "array",
+                  "items": {
+                    "$ref": "#/components/schemas/Pet"
+                  },
+                  "x-cadl-name": "PetStore.Pet[]"
                 }
               }
             }
@@ -64,14 +70,14 @@
         }
       },
       "post": {
-        "summary": "Create a pet",
         "operationId": "createPets",
         "tags": [
           "pets"
         ],
+        "parameters": [],
         "responses": {
           "201": {
-            "description": "Null response"
+            "description": "The request has succeeded and a new resource has been created as a result."
           },
           "default": {
             "description": "unexpected error",
@@ -88,7 +94,6 @@
     },
     "/pets/{petId}": {
       "get": {
-        "summary": "Info for a specific pet",
         "operationId": "showPetById",
         "tags": [
           "pets"
@@ -100,13 +105,14 @@
             "required": true,
             "description": "The id of the pet to retrieve",
             "schema": {
-              "type": "string"
+              "type": "string",
+              "description": "The id of the pet to retrieve"
             }
           }
         ],
         "responses": {
           "200": {
-            "description": "Expected response to a valid request",
+            "description": "The request has succeeded.",
             "content": {
               "application/json": {
                 "schema": {
@@ -150,12 +156,6 @@
           }
         }
       },
-      "Pets": {
-        "type": "array",
-        "items": {
-          "$ref": "#/components/schemas/Pet"
-        }
-      },
       "Error": {
         "type": "object",
         "required": [
@@ -170,7 +170,8 @@
           "message": {
             "type": "string"
           }
-        }
+        },
+        "description": "unexpected error"
       }
     }
   }
```

:::

ç§ãŒ cadl ã«æœŸå¾…ã—ã¦ã„ã‚‹ã“ã¨ã¯ [ä»Šã•ã‚‰Protocol Buffersã¨ã€æ‰‹ã«é¦´æŸ“ã‚€é“å…·ã®è©±](https://qiita.com/yugui/items/160737021d25d761b353#protobuf%E3%81%AF%E3%81%AA%E3%81%9C%E8%89%AF%E3%81%84%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E8%A8%80%E8%AA%9E%E3%81%AA%E3%81%AE%E3%81%8B) ã§ yugui ã•ã‚“ãŒ Protobuf ã®è‰¯ã•ã«ã¤ã„ã¦è©±ã—ã¦ã„ã‚‹ã¨ãã®

> ç°¡ç´ ã§å¯èª­ã§ã€å‰²ã¨ä½•ã«ã§ã‚‚ä½¿ãˆã¦ã€ã—ã‹ã—ã™ã¹ã¦ã‚’ã‚«ãƒãƒ¼ã—ã‚ˆã†ã¨ã—ã¦è†¨ã‚Œã‚ãŒã£ã¦ãŠã‚‰ãšã€ãƒ„ãƒ¼ãƒ«ã‚’æ‹¡å¼µå¯èƒ½ã€‚ã¨ã‚Šã‚ã‘ä½•ã‹ãŒã™ã”ãè‰¯ã„ã¨ã„ã†è¨³ã§ã‚‚ãªã„ã‘ã‚Œã©ã‚‚ã€ã™ã“ã—ä½¿ã„è¾¼ã‚ã°ã“ã®ç´ æœ´ã•ãŒæ‰‹ã«é¦´æŸ“ã¿ã‚„ã™ã„ã€‚

ã¨åŒã˜ã ã‚ã†ã€‚

ãã‚Œã§ã¯ Protobuf ã§ã„ã„ã¨ã‚‚æ€ãˆã‚‹ã®ã ãŒã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³å½¢å¼è¨˜è¿°ã¨ã—ã¦ã® Protobuf ã¨ã‚¹ã‚­ãƒ¼ãƒå½¢å¼è¨˜è¿°ã® Protobuf ã‚’åˆ†ã‘ã¦æ‰ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ãªã„ã¨ã€ã‚¿ã‚°ã®è¨˜è¿°ã®è¦‹æ…£ã‚Œãªã•ã‚„ã€ã‚¿ã‚°ã«ä½•ã‚’æ›¸ã„ãŸã‚‰ã„ã„ã‹ã‚ã‹ã‚‰ãªããªã‚‹ã¨ã“ã‚ãŒ Protobuf ã§ã‚¹ã‚­ãƒ¼ãƒã‚’è¨˜è¿°ã™ã‚‹ã¨ãã®é›£ç‚¹ã ã¨æ€ã†ã€‚

cadl ã¯ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³å½¢å¼è¨˜è¿°ã‚’ç¬¬ä¸€ç›®çš„ã¨ã—ãŸè¨€èªã§ã¯ãªã„ã®ã§ã€ã‚¹ã‚­ãƒ¼ãƒè¨˜è¿°ã«ç‰¹åŒ–ã§ãã¦ã„ã¦ã€ãªãŠã‹ã¤äººé–“ãŒåŠå¹´ãã‚‰ã„ã®ãƒ–ãƒ©ãƒ³ã‚¯ã‚’çµŒãŸã‚ã¨ã§ã‚‚èª­ã¿æ›¸ãå¯èƒ½ãã†ãªç°¡æ½”ã•ã‚’å‚™ãˆã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚
