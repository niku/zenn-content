---
title: "Elixirã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚’Stackdriverã®Loggingã¸é€ã‚‹"
emoji: "ğŸƒ"
type: "tech"
topics:
  - "elixir"
  - "gcp"
published: true
published_at: "2021-07-20 20:14"
---

GCP ã«ã¯ãƒ­ã‚°ã®åé›†ã€ä¿ç®¡ã€æ¤œç´¢ã‚’å®¹æ˜“ã«è¡Œãˆã‚‹[Stackdriver Logging](https://cloud.google.com/logging/)ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚‹ã€‚Elixir ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚’ Stackdriver Logging ã¸é€ã‚‹æ–¹æ³•ã‚’æ›¸ãã€‚

Stackdriver ã¯ GCP ã®æ°¸ä¹…ç„¡æ–™æ (always free)ã§åˆ©ç”¨å¯èƒ½ã§ã‚ã‚Šã€[Pricing](https://cloud.google.com/stackdriver/pricing)ã«ã‚ˆã‚‹ã¨ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯ã« 1 ãƒ¶æœˆã‚ãŸã‚Š 50GiB ãŒç„¡æ–™æ ã¨ãªã‚‹ãã†ã ã€‚ï¼ˆ50GiB ã¨ã„ã†è¡¨è¨˜ã¯ä½•ã‹ã®é–“é•ã„ã§ã¯ãªã„ã‹ã¨æ€ãˆã‚‹ã»ã©ã®é‡ã§ã‚ã‚‹ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ãã†æ›¸ã„ã¦ã‚ã‚‹ï¼‰

Elixir ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚’ Stackdrive Logging ã¸é€ã‚‹æœ€å°é™ã®è¨­å®šã‚’ç™ºè¦‹ã§ããŸã€‚2019-08-25 ç¾åœ¨ã¯ Google ã‚„ Github ã®ã‚³ãƒ¼ãƒ‰æ¤œç´¢ã‚’ã—ã¦ã¿ãŸã‚‚ã®ã®è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸã€‚ã“ã®è¨˜éŒ²ãŒèª°ã‹ã®å½¹ã«ç«‹ã¤ã¨ã†ã‚Œã—ã„ã€‚

åˆ©ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- [goth](https://hex.pm/packages/goth) v1.1.0
- [google_api_logging](https://hex.pm/packages/google_api_logging) v0.12.0

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- GCP ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚ä»Šå›ã¯ `my-project` ã¨ã„ã†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãŸ
- ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« Editor role ã‚’ä»˜åŠ ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ ![](https://storage.googleapis.com/f8b532e65602c939b955db2a16a1b23b/868EC6D7-740A-4D5A-BD1C-B7839DB1AE1F.png)
- `mix.exs` ã¸ `goth` ã¨ `google_api_logging` ã®ä¾å­˜ã‚’è¿½åŠ ã™ã‚‹
  - [goth](https://github.com/peburrows/goth/blob/v1.1.0/README.md#installation)
  - [google_api_logging](https://github.com/googleapis/elixir-google-api/blob/fe25647f9af06be8f876e75bf9346cf04dc52481/clients/logging/README.md#installation)
- `goth` ã®ãŸã‚ã« Elixir ã§ json å½¢å¼ã® private key ã‚’èª­ã¿ã“ã‚€
  - [Service accounts](https://console.cloud.google.com/iam-admin/serviceaccounts)ã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã® private key ã‚’ json å½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
  - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ json ã‚’èª­ã¿è¾¼ã‚€ã‚ˆã† Elixir ã® config ã‚’è¨­å®šã™ã‚‹
    - ç§ã¯ `GCP_CREDENTIALS` ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã« json ã‚’ 1 è¡Œã«ã—ãŸã‚‚ã®ã‚’ç›´æ¥æ›¸ãã“ã‚€æ–¹æ³•ã‚’æ¡ç”¨ã—ãŸ
    - TIPS: `jq -c . lateral-yew-251023-06197db86c63.json` ã®ã‚ˆã†ãªå½¢ã§ json ã‚’ 1 è¡Œã«ã—ãŸã‚‚ã®ã‚’å–å¾—ã§ãã‚‹

å®Ÿè¡Œ

```elixir
# GCPã«ä½œæˆã—ãŸprojectã®IDã€‚Nameã§ã¯ãªãã€IDã®æ–¹ã€‚
my_project_id = "lateral-yew-251023"

# ä»¥ä¸‹ã‚’æº€ãŸã™ä»»æ„ã®ãƒ­ã‚°å
# - 512æ–‡å­—ä»¥ä¸‹
# - å¤§æ–‡å­—ã€å°æ–‡å­—ã®è‹±æ–‡å­—
# - ã‚¹ãƒ©ãƒƒã‚·ãƒ¥(/)ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢(_)ã€ãƒã‚¤ãƒ•ãƒ³(-)ã€ãƒ”ãƒªã‚ªãƒ‰(.)
my_log_name = "my_log_name"

# Gothã‚’åˆ©ç”¨ã—Stackdriverã«é€ä»˜ã™ã‚‹æ¨©é™ã‚’æŒã£ãŸtokenã‚’å–å¾—ã™ã‚‹
#
# æœ‰åŠ¹ãªæ–‡å­—åˆ—ã¯ä»¥ä¸‹ã®URLã‚’å‚ç…§ã®ã“ã¨ã€‚
# https://cloud.google.com/logging/docs/access-control#scopes
{:ok, %{token: token}} = Goth.Token.for_scope("https://www.googleapis.com/auth/logging.write")
conn = GoogleApi.Logging.V2.Connection.new(token)

# ç›£è¦–ã—ã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ãŠã‚ˆã³åå‰
#
# https://hexdocs.pm/google_api_logging/0.12.0/api-reference.html
#
# typeã¨lobalã®æœ‰åŠ¹ãªçµ„ã¿åˆã‚ã›ã¯ä»¥ä¸‹ã®URLã‚’å‚ç…§ã®ã“ã¨ã€‚
# https://cloud.google.com/logging/docs/api/v2/resource-list#resource-types
#
# GCPã§ã‚‚AWSã§ã‚‚ãªã„å ´æ‰€ã‹ã‚‰åˆ©ç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ãã®typeã¯globalãã‚‰ã„ã—ã‹è©²å½“ã™ã‚‹ã‚‚ã®ãŒãªã•ãã†ã ã£ãŸã€‚
# GCPã‚„AWSã‹ã‚‰ã®å ´åˆã¯generic_nodeã‚„generic_taskã‚‚æ¤œè¨ã«å€¤ã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚
monitored_resource = %GoogleApi.Logging.V2.Model.MonitoredResource{type: "global", labels: %{project_id: my_project_id}}

# Stackdriverã«é€ã‚ŠãŸã„ãƒ­ã‚°ã‚’ä½œã‚‹
#
# https://hexdocs.pm/google_api_logging/0.12.0/GoogleApi.Logging.V2.Model.LogEntry.html
#
# logNameã§ã¯ã©ã®ã‚ˆã†ãªå€¤ãŒæœ‰åŠ¹ã‹ã¯ä»¥ä¸‹ã®URLã«ã‚ã‚‹logNameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è§£èª¬ãŒèª­ã¿ã‚„ã™ã„ã€‚
# https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry
#
# StackdriverãŒåˆã‚ã¦ã®logNameã‚’å—ã‘ã¨ã‚‹ã¨ã€ãã®logNameã®logsãŒæ–°è¦ä½œæˆã•ã‚Œã‚‹ã€‚
# logNameã‚’åã‚ã‚‹å ´æ‰€ã‚’ä½œæˆã™ã‚‹ã¨ã„ã†æ‰‹é †ã¯å¿…è¦ãªã„ã€‚
# https://cloud.google.com/logging/docs/api/tasks/creating-logs#creating_logs
entry = %GoogleApi.Logging.V2.Model.LogEntry{resource: monitored_resource, logName: "projects/#{my_project_id}/logs/#{my_log_name}", textPayload: "Hello StackDriver!!"}

# Stackdriverã¸é€ã‚ŠãŸã„ãƒ­ã‚°ã®ã¾ã¨ã¾ã‚Šã‚’ä½œã‚‹
#
# https://hexdocs.pm/google_api_logging/0.12.0/GoogleApi.Logging.V2.Model.WriteLogEntriesRequest.html
#
# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€ãƒ­ã‚°ã‚’æ²¢å±±é€ã‚‹ã‚ˆã†ãªç’°å¢ƒã§ã¯ã€é€ä¿¡ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Šã‚„Stackdriverã®ã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™ã«ã‹ã‹ã‚‰ãªã„ã‚ˆã†ã«Entryã‚’è¤‡æ•°ãƒªã‚¹ãƒˆã«ã—ã¦é€ã‚‹ã¨ã‚ˆã„ã‚ˆã†ã ã€‚
entries = %GoogleApi.Logging.V2.Model.WriteLogEntriesRequest{entries: [entry]}

# Stackdriverã¸ãƒ­ã‚°ã‚’é€ã‚‹
#
# https://hexdocs.pm/google_api_logging/GoogleApi.Logging.V2.Api.Entries.html#logging_entries_write/3
{:ok, _} = GoogleApi.Logging.V2.Api.Entries.logging_entries_write(conn, body: entries)
```

[Viewer](https://console.cloud.google.com/logs/viewer)ã‚’é–‹ãã€Resouce ã®é¸æŠç”»é¢ã‚’ Global ã«ã™ã‚‹ã¨ Stackdriver ã¸æ›¸ãã“ã‚“ã ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã€‚

![](https://storage.googleapis.com/f8b532e65602c939b955db2a16a1b23b/A7672130-F9D3-407C-A0D9-E07A64BFA9F5.png)
